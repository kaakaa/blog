<!doctype html><html lang=ja-jp>
<head>
<meta charset=utf-8>
<title>Mattermostの日本語検索を改善するためにBleveSearchを少し調査した</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7H97CTR9R6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-7H97CTR9R6')</script>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Mattermostの日本語検索を改善するためにBleveSearchを少し調査した">
<meta name=twitter:description content="背景: Mattermost Bleve検索 2021/06にリリースされたMattermost v5.24から、Bleveによるメッセージの日本語検索が利用できるよ">
<meta property="og:title" content="Mattermostの日本語検索を改善するためにBleveSearchを少し調査した">
<meta property="og:description" content="背景: Mattermost Bleve検索 2021/06にリリースされたMattermost v5.24から、Bleveによるメッセージの日本語検索が利用できるよ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.kaakaa.dev/post/tech/enhancement-mattermost-japanese-search/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-08-16T17:00:00+09:00">
<meta property="article:modified_time" content="2022-08-16T17:00:00+09:00">
<link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css>
<link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css>
<script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script>
<script src=https://blog.kaakaa.dev/js/main.bundle.js></script>
<script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script>
<meta name=generator content="Hugo 0.91.2">
</head>
<body>
<header>
<nav class=navbar>
<div class=nav>
<a href=https://blog.kaakaa.dev/ class=nav-logo>
<img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo>
</a>
<ul class=nav-links>
<li>
<a href=/ id=Home><em class="fas fa-home fa-lg"></em></a>
</li>
<li>
<a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a>
</li>
<li>
<a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a>
</li>
<li>
<a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a>
</li>
<li>
<a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a>
</li>
</ul>
</div>
</nav>
<div class=intro-header>
<div class=container>
<div class=post-heading>
<h1>
Mattermostの日本語検索を改善するためにBleveSearchを少し調査した
</h1>
<span class=meta-post>
<em class="fa fa-calendar-alt"></em>&nbsp;Aug 16, 2022
</span>
</div>
</div>
</div>
</header>
<div class=container role=main>
<article class=article class=blog-post>
<nav id=TableOfContents>
<ul>
<li><a href=#背景-mattermost-bleve検索>背景: Mattermost Bleve検索</a></li>
<li><a href=#問題-意図せぬ投稿が検索される>問題: 意図せぬ投稿が検索される</a></li>
<li><a href=#調査1-bleveのcjk言語向けanalyzer>調査1: Bleveのcjk言語向けAnalyzer</a></li>
<li><a href=#調査2-bleve-cjk-analyzerを使用した際に1語検索ができるようにする>調査2: Bleve <code>cjk</code> Analyzerを使用した際に1語検索ができるようにする</a></li>
<li><a href=#おわりに>おわりに</a></li>
</ul>
</nav><h2 id=背景-mattermost-bleve検索>背景: Mattermost Bleve検索</h2>
<p>2021/06にリリースされたMattermost v5.24から、<a href=https://zenn.dev/kaakaa/articles/qiita-20200620-574972591f6b0b0f642f#bleve-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%81%A7%E6%97%A5%E6%9C%AC%E8%AA%9E%E6%A4%9C%E7%B4%A2%E3%82%82%E5%8F%AF%E8%83%BD%E3%81%AB%EF%BC%81%EF%BC%88%E5%AE%9F%E9%A8%93%E7%9A%84%E6%A9%9F%E8%83%BD%EF%BC%89>Bleveによるメッセージの日本語検索が利用できるようになった</a>。</p>
<p><a href=https://docs.mattermost.com/deploy/bleve-search.html>Bleve search (experimental)</a></p>
<p>それ以前のバージョンでは、<a href=https://docs.mattermost.com/configure/enabling-chinese-japanese-korean-search.html#japanese>Mattermostセットアップ時にDB(MySQL, PostgreSQL)の設定に手を加える</a>必要があったが、Bleveによる検索機能が公式にサポートされたことで、システムコンソール画面からいくつか設定を変更するだけで日本語検索が実現できるようになった。嬉しい。</p>
<h2 id=問題-意図せぬ投稿が検索される>問題: 意図せぬ投稿が検索される</h2>
<p>Bleve検索自体はとても便利な機能だが、その検索結果に少し問題がある。</p>
<p>2文字以上の単語で構成される日本語クエリによるBleve検索をおこなった際、本来ならばその単語が出現する投稿のみが検索結果として表示して欲しいところだが、実際の検索結果には、その単語内で使用されている文字が全て現れる投稿を検索してしまう。</p>
<p>例えば、「メロスは激怒した。必ず、かの邪智暴虐の王を除かなければならぬと決意した。」という投稿があったとする。</p>
<p>「激怒」「邪智暴虐」などの単語で検索を行うと、想定通りこの投稿を検索することができる。しかし、「激暴」という単語で検索を行った場合も、この単語自体は対象の投稿に存在しないにも関わらず、単語を構成する「激」「暴」の両方の文字が投稿に含まれているため、対象の投稿が検索結果として表示されてしまう。</p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/problem-bleve-search.png alt=problem-bleve-search></p>
<p>この問題を改善するため、調査を行った。</p>
<h2 id=調査1-bleveのcjk言語向けanalyzer>調査1: Bleveのcjk言語向けAnalyzer</h2>
<p>まず、Mattermost側でBleveをどのように使用しているかを調べる。</p>
<p>投稿内容のインデックスは、以下で定義されている。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#f92672>import</span> (
    <span style=color:#f92672>...</span>
	<span style=color:#e6db74>&#34;github.com/blevesearch/bleve/v2/analysis/analyzer/standard&#34;</span>
    <span style=color:#f92672>...</span>
)
<span style=color:#f92672>...</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
    <span style=color:#f92672>...</span>
	<span style=color:#a6e22e>standardMapping</span> = <span style=color:#a6e22e>bleve</span>.<span style=color:#a6e22e>NewTextFieldMapping</span>()
	<span style=color:#a6e22e>standardMapping</span>.<span style=color:#a6e22e>Analyzer</span> = <span style=color:#a6e22e>standard</span>.<span style=color:#a6e22e>Name</span>
    <span style=color:#f92672>...</span>
}
<span style=color:#f92672>...</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getPostIndexMapping</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>mapping</span>.<span style=color:#a6e22e>IndexMappingImpl</span> {
	<span style=color:#a6e22e>postMapping</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bleve</span>.<span style=color:#a6e22e>NewDocumentMapping</span>()
    <span style=color:#f92672>...</span>
	<span style=color:#a6e22e>postMapping</span>.<span style=color:#a6e22e>AddFieldMappingsAt</span>(<span style=color:#e6db74>&#34;Message&#34;</span>, <span style=color:#a6e22e>standardMapping</span>)
    <span style=color:#f92672>...</span>
}
</code></pre></div><p><a href=https://github.com/mattermost/mattermost-server/blob/5ea2ca8a3a25cb89b4cf52012ae3897d03e0a64f/services/searchengine/bleveengine/bleve.go#L79>https://github.com/mattermost/mattermost-server/blob/5ea2ca8a3a25cb89b4cf52012ae3897d03e0a64f/services/searchengine/bleveengine/bleve.go#L79</a></p>
<p>Mattermostの投稿(<code>Post</code>)の内容(<code>Message</code>)は、Bleveの<code>standard.Name</code>で表されるAnalyzerによって解析されるようだ。Bleveについてあまり詳しくはないが、<code>standard.Name</code>で表されるAnalyzerの内容を見ると、<code>en.StopName</code>が使われており、英文を前提としたAnalyzerだと考えられるので、この部分が問題なのではないかと思う。<br>
<a href=https://github.com/blevesearch/bleve/blob/master/analysis/analyzer/standard/standard.go>https://github.com/blevesearch/bleve/blob/master/analysis/analyzer/standard/standard.go</a></p>
<p>BleveのAnalyzerについて調べていると、<code>cjk</code>向けのAnalyzerもあることが分かった。<br>
<a href=https://github.com/blevesearch/bleve/tree/master/analysis/lang/cjk>https://github.com/blevesearch/bleve/tree/master/analysis/lang/cjk</a></p>
<p>単純にMattermostの投稿内容のインデックスをBleveの<code>cjk</code> Analyzerを使って行うよう変更してみる。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=color:#75715e>@@ -14,7 +14,7 @@ import (
</span><span style=color:#75715e></span> 
        &#34;github.com/blevesearch/bleve/v2&#34;
        &#34;github.com/blevesearch/bleve/v2/analysis/analyzer/keyword&#34;
<span style=color:#f92672>-       &#34;github.com/blevesearch/bleve/v2/analysis/analyzer/standard&#34;
</span><span style=color:#f92672></span><span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/analysis/lang/cjk&#34;
</span><span style=color:#a6e22e></span>        &#34;github.com/blevesearch/bleve/v2/mapping&#34;
 
        &#34;github.com/mattermost/mattermost-server/v6/model&#34;
<span style=color:#75715e>@@ -49,7 +49,7 @@ func init() {
</span><span style=color:#75715e></span>        keywordMapping.Analyzer = keyword.Name
 
        standardMapping = bleve.NewTextFieldMapping()
<span style=color:#f92672>-       standardMapping.Analyzer = standard.Name
</span><span style=color:#f92672></span><span style=color:#a6e22e>+       standardMapping.Analyzer = cjk.AnalyzerName
</span><span style=color:#a6e22e></span> 
</code></pre></div><p>この変更を有効にしてMattermostを再起動し、Bleveインデックスを破棄→再構築すると、「激暴」という単語で当該の投稿が検索されなくなった。</p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/bleve-search-improve1-1.png alt=bleve-search-improve1-1></p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/bleve-search-improve1-2.png alt=bleve-search-improve1-2></p>
<p>めでたしめでたし。</p>
<p>&mldr;とはならなかった。</p>
<p>上記の変更を加えたことで、今度は1語による検索ができなくなった。</p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/problem-bleve-search2.png alt=problem-bleve-search2></p>
<p>「検索は2語以上で」という制限を設ければ問題は解決だが、この制限はあまり好ましくない。</p>
<h2 id=調査2-bleve-cjk-analyzerを使用した際に1語検索ができるようにする>調査2: Bleve <code>cjk</code> Analyzerを使用した際に1語検索ができるようにする</h2>
<p>Bleveの<code>cjk</code> AnalyzerはTokenFilterとしてBigramを使用している。つまり、2語ずつインデックスを構築しているので、1語での検索ができないようだ。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AnalyzerName</span> = <span style=color:#e6db74>&#34;cjk&#34;</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AnalyzerConstructor</span>(<span style=color:#a6e22e>config</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Cache</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>analysis</span>.<span style=color:#a6e22e>Analyzer</span>, <span style=color:#66d9ef>error</span>) {
    <span style=color:#f92672>...</span>
	<span style=color:#a6e22e>bigramFilter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>TokenFilterNamed</span>(<span style=color:#a6e22e>BigramName</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>rv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>analysis</span>.<span style=color:#a6e22e>Analyzer</span>{
		<span style=color:#a6e22e>Tokenizer</span>: <span style=color:#a6e22e>tokenizer</span>,
		<span style=color:#a6e22e>TokenFilters</span>: []<span style=color:#a6e22e>analysis</span>.<span style=color:#a6e22e>TokenFilter</span>{
			<span style=color:#a6e22e>widthFilter</span>,
			<span style=color:#a6e22e>toLowerFilter</span>,
			<span style=color:#a6e22e>bigramFilter</span>,
		},
	}
    <span style=color:#f92672>...</span>
}
<span style=color:#f92672>...</span>
</code></pre></div><p><a href=https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/analysis/lang/cjk/analyzer_cjk.go#L40>https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/analysis/lang/cjk/analyzer_cjk.go#L40</a></p>
<p>もう一度、Bleveの<code>cjk</code>パッケージを見てみると<code>output_unigram</code>という設定があることに気づく。名前から、この設定を<code>On</code>にしてインデックスを構築することで、1語のインデックスも出力されるようになるのではないかと予想する。(それによるインデックスサイズの増加についてはここでは考慮しないことにする)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CJKBigramFilterConstructor</span>(<span style=color:#a6e22e>config</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Cache</span>) (<span style=color:#a6e22e>analysis</span>.<span style=color:#a6e22e>TokenFilter</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>outputUnigram</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
	<span style=color:#a6e22e>outVal</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>[<span style=color:#e6db74>&#34;output_unigram&#34;</span>].(<span style=color:#66d9ef>bool</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
		<span style=color:#a6e22e>outputUnigram</span> = <span style=color:#a6e22e>outVal</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewCJKBigramFilter</span>(<span style=color:#a6e22e>outputUnigram</span>), <span style=color:#66d9ef>nil</span>
}
<span style=color:#f92672>...</span>
</code></pre></div><p><a href=https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/analysis/lang/cjk/cjk_bigram.go#L185>https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/analysis/lang/cjk/cjk_bigram.go#L185</a></p>
<p><code>output_unigram</code>の設定をOnにする方法について色々調べてみたが、どうやってもOnにする方法が見つからない(これがこの記事を書くきっかけだったりする)。</p>
<p>以下の<code>ItemNamed</code>関数内で実行している<code>build(name, nil, cache)</code>の第二引数が前述の<code>CJKBigramFilterConstructor</code>関数の第一引数 (<code>config</code>)になり、ここに<code>output_unigram: true</code>が設定されていれば有効にできるらしいが、<code>nil</code>でハードコードされているのでどうしようもない。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConcurrentCache</span>) <span style=color:#a6e22e>ItemNamed</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Cache</span>, <span style=color:#a6e22e>build</span> <span style=color:#a6e22e>CacheBuild</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
    <span style=color:#f92672>...</span>
	<span style=color:#75715e>// try to build it
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>newItem</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>build</span>(<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>cache</span>)
    <span style=color:#f92672>...</span>
}
</code></pre></div><p><a href=https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/registry/cache.go#L47>https://github.com/blevesearch/bleve/blob/d89c6c0a6873fcca1673fb6e7e3128d39bc6494d/registry/cache.go#L47</a></p>
<p>自分が気づいていない方法があるのかも知れないが、調べていてもわからないので、<code>output_unigram</code>を<code>true</code>にしたAnalyzerを新たに登録し、それを使用してみる。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=color:#75715e>@@ -13,9 +13,13 @@ import (
</span><span style=color:#75715e></span>        &#34;time&#34;
 
        &#34;github.com/blevesearch/bleve/v2&#34;
<span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/analysis&#34;
</span><span style=color:#a6e22e></span>        &#34;github.com/blevesearch/bleve/v2/analysis/analyzer/keyword&#34;
<span style=color:#f92672>-       &#34;github.com/blevesearch/bleve/v2/analysis/analyzer/standard&#34;
</span><span style=color:#f92672></span><span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/analysis/lang/cjk&#34;
</span><span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/analysis/token/lowercase&#34;
</span><span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/analysis/tokenizer/unicode&#34;
</span><span style=color:#a6e22e></span>        &#34;github.com/blevesearch/bleve/v2/mapping&#34;
<span style=color:#a6e22e>+       &#34;github.com/blevesearch/bleve/v2/registry&#34;
</span><span style=color:#a6e22e></span> 
        &#34;github.com/mattermost/mattermost-server/v6/model&#34;
        &#34;github.com/mattermost/mattermost-server/v6/shared/mlog&#34;
<span style=color:#75715e>@@ -44,12 +48,50 @@ var keywordMapping *mapping.FieldMapping
</span><span style=color:#75715e></span> var standardMapping *mapping.FieldMapping
 var dateMapping *mapping.FieldMapping
 
<span style=color:#a6e22e>+const customCJKAnalyzerName = &#34;custom_cjk_analyzer&#34;
</span><span style=color:#a6e22e>+const customCJKTokenFilterName = &#34;custom_cjk_filter&#34;
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+func CustomCJKAnalyzerConstructor(config map[string]interface{}, cache *registry.Cache) (*analysis.Analyzer, error) {
</span><span style=color:#a6e22e>+       tokenizer, err := cache.TokenizerNamed(unicode.Name)
</span><span style=color:#a6e22e>+       if err != nil {
</span><span style=color:#a6e22e>+               return nil, err
</span><span style=color:#a6e22e>+       }
</span><span style=color:#a6e22e>+       widthFilter, err := cache.TokenFilterNamed(cjk.WidthName)
</span><span style=color:#a6e22e>+       if err != nil {
</span><span style=color:#a6e22e>+               return nil, err
</span><span style=color:#a6e22e>+       }
</span><span style=color:#a6e22e>+       toLowerFilter, err := cache.TokenFilterNamed(lowercase.Name)
</span><span style=color:#a6e22e>+       if err != nil {
</span><span style=color:#a6e22e>+               return nil, err
</span><span style=color:#a6e22e>+       }
</span><span style=color:#a6e22e>+       bigramFilter, err := cache.TokenFilterNamed(customCJKTokenFilterName)
</span><span style=color:#a6e22e>+       if err != nil {
</span><span style=color:#a6e22e>+               return nil, err
</span><span style=color:#a6e22e>+       }
</span><span style=color:#a6e22e>+       rv := analysis.Analyzer{
</span><span style=color:#a6e22e>+               Tokenizer: tokenizer,
</span><span style=color:#a6e22e>+               TokenFilters: []analysis.TokenFilter{
</span><span style=color:#a6e22e>+                       widthFilter,
</span><span style=color:#a6e22e>+                       toLowerFilter,
</span><span style=color:#a6e22e>+                       bigramFilter,
</span><span style=color:#a6e22e>+               },
</span><span style=color:#a6e22e>+       }
</span><span style=color:#a6e22e>+       return &amp;rv, nil
</span><span style=color:#a6e22e>+}
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+func CustomCJKBigramFilterConstructor(config map[string]interface{}, cache *registry.Cache) (analysis.TokenFilter, error) {
</span><span style=color:#a6e22e>+       return cjk.NewCJKBigramFilter(true), nil
</span><span style=color:#a6e22e>+}
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e></span> func init() {
<span style=color:#a6e22e>+       registry.RegisterTokenFilter(customCJKTokenFilterName, CustomCJKBigramFilterConstructor)
</span><span style=color:#a6e22e>+       registry.RegisterAnalyzer(customCJKAnalyzerName, CustomCJKAnalyzerConstructor)
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e></span>        keywordMapping = bleve.NewTextFieldMapping()
        keywordMapping.Analyzer = keyword.Name
 
        standardMapping = bleve.NewTextFieldMapping()
<span style=color:#f92672>-       standardMapping.Analyzer = standard.Name
</span><span style=color:#f92672></span><span style=color:#a6e22e>+       standardMapping.Analyzer = customCJKAnalyzerName
</span><span style=color:#a6e22e></span> 
        dateMapping = bleve.NewNumericFieldMapping()
 }
</code></pre></div><p>冗長だ。</p>
<p>再びMattermostを再起動、Bleveインデックスの破棄→再構築を行い検索を実行すると、1語でも検索ができるようになった。</p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/bleve-search-improve2-1.png alt=bleve-search-improve2-1></p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/bleve-search-improve2-2.png alt=bleve-search-improve2-2></p>
<p><img src=https://blog.kaakaa.dev/images/posts/tech/bleve-search/bleve-search-improve2-3.png alt=bleve-search-improve2-3></p>
<h2 id=おわりに>おわりに</h2>
<p>というわけで、MattermostのBleveによる日本語検索の改善について調べてみた。<br>
とりあえず小さなサンプルでは実現可能なことが分かったが、<code>output_unigram</code>の設定のせいで修正量が多くなりそうなので、もう少し調査してからIssueで報告しようと思う。</p>
<p>調査内容としては以下のあたりかな。</p>
<ul>
<li>検索内容の正当性
<ul>
<li>日本語検索のテストセットが欲しいな&mldr;</li>
</ul>
</li>
<li>検索インデックスの容量増加
<ul>
<li>日本語の投稿がたくさんあるMattermostインスタンスのデータが欲しいな&mldr;</li>
</ul>
</li>
<li><code>blevex</code>のkagomeを使用した検索
<ul>
<li><code>blevex</code>のREADMEを見ると、Mattermost本体に組み込んでメンテし続けるのはちょっと怖い気がするな&mldr;</li>
</ul>
</li>
</ul>
<p>Mattermostで実装するときは、Bleveの設定画面でAnalyzer選ぶような感じになるのかな。CJK以外でAnalyzer変更が必要な言語が無かったりすると、ちょっと独自改造っぽい感じになるので受け入れられにくそうな感じもするな。</p>
<div class=blog-tags>
<a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/bleve/>bleve</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/japanese/>japanese</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/search/>search</a>&nbsp;
</div>
</article>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<footer>
<div class=social-icons>
<a href=https://github.com/kaakaa name=GitHub>
<em class="fab fa-github-alt fa-lg"></em>
</a>
&nbsp;&ndash;&nbsp;
<a href=https://twitter.com/kaakaa_hoe_prog name=Twitter>
<em class="fab fa-twitter fa-lg"></em>
</a>
&nbsp;&ndash;&nbsp;
<a class=social-icon href=https://zenn.dev/kaakaa name=Zenn>
<img src=https://blog.kaakaa.dev/images/zenn.svg alt=Zenn>
</a>
&nbsp;&ndash;&nbsp;
<a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita>
<img src=https://blog.kaakaa.dev/images/qiita.png alt=Qiita>
</a>
</div>
<div class=container>
<p class="credits copyright">
<a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2023
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em>
</p>
<p class="credits theme-by">
Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a>
</p>
</div>
</footer>
</body>
</html>