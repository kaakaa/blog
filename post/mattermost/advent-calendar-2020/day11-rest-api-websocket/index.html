<!doctype html><html lang=ja-jp>
<head>
<meta charset=utf-8>
<title>[Mattermost Integrations] REST API (WebSocket)</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7H97CTR9R6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-7H97CTR9R6')</script>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="[Mattermost Integrations] REST API (WebSocket)">
<meta name=twitter:description content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第11日目の記事です。 本記事では、Mat">
<meta property="og:title" content="[Mattermost Integrations] REST API (WebSocket)">
<meta property="og:description" content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第11日目の記事です。 本記事では、Mat">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.kaakaa.dev/post/mattermost/advent-calendar-2020/day11-rest-api-websocket/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-12-11T00:00:00+09:00">
<meta property="article:modified_time" content="2020-12-11T00:00:00+09:00">
<link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css>
<link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css>
<script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script>
<script src=https://blog.kaakaa.dev/js/main.bundle.js></script>
<script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script>
<meta name=generator content="Hugo 0.91.2">
</head>
<body>
<header>
<nav class=navbar>
<div class=nav>
<a href=https://blog.kaakaa.dev/ class=nav-logo>
<img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo>
</a>
<ul class=nav-links>
<li>
<a href=/ id=Home><em class="fas fa-home fa-lg"></em></a>
</li>
<li>
<a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a>
</li>
<li>
<a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a>
</li>
<li>
<a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a>
</li>
<li>
<a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a>
</li>
</ul>
</div>
</nav>
<div class=intro-header>
<div class=container>
<div class=post-heading>
<h1>
[Mattermost Integrations] REST API (WebSocket)
</h1>
<span class=meta-post>
<em class="fa fa-calendar-alt"></em>&nbsp;Dec 11, 2020
</span>
</div>
</div>
</div>
</header>
<div class=container role=main>
<article class=article class=blog-post>
<p>Mattermost記事まとめ: <a href=https://blog.kaakaa.dev/tags/mattermost/>https://blog.kaakaa.dev/tags/mattermost/</a></p>
<nav id=TableOfContents>
<ul>
<li><a href=#本記事について>本記事について</a></li>
<li><a href=#websocket-apiの概要>WebSocket APIの概要</a></li>
<li><a href=#websocketイベントの取得>WebSocketイベントの取得</a></li>
<li><a href=#websocket-apiの実行>WebSocket APIの実行</a></li>
<li><a href=#さいごに>さいごに</a></li>
</ul>
</nav><h2 id=本記事について>本記事について</h2>
<p><a href=https://qiita.com/advent-calendar/2020/mattermost-integrations>Mattermostの統合機能アドベントカレンダー</a>の第11日目の記事です。</p>
<p>本記事では、MattermostのWebSocket APIついて紹介します。</p>
<h2 id=websocket-apiの概要>WebSocket APIの概要</h2>
<p>MattermostはWebSocket APIを利用することで、Mattermost上でやり取りされているWebSocketのイベントを取得することもできます。</p>
<p>WebSocket APIについてはREST APIのドキュメントに説明があります。
<a href=https://api.mattermost.com/#tag/WebSocket>https://api.mattermost.com/#tag/WebSocket</a></p>
<h2 id=websocketイベントの取得>WebSocketイベントの取得</h2>
<p>MattermostのWebSocket Eventを取得するために、Mattermost公式のWebSocketクライアント <a href=https://github.com/mattermost/mattermost-server/blob/master/model/websocket_client.go>websocket_client.go</a> を利用します。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;log&#34;</span>

	<span style=color:#e6db74>&#34;github.com/mattermost/mattermost-server/v5/model&#34;</span>
)

<span style=color:#66d9ef>const</span> (
  <span style=color:#75715e>// (1) Mattermost WebSocket Endpoint
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>MattermostWebSocketURL</span> = <span style=color:#e6db74>&#34;ws://localhost:8065&#34;</span>
  <span style=color:#75715e>// (2) Access Token
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>AccessToken</span>            = <span style=color:#e6db74>&#34;4cacdozwn3fndnzobbpha3nnhy&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
  <span style=color:#75715e>// (3) WebSocket Clientの構築
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>appErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>NewWebSocketClient4</span>(<span style=color:#a6e22e>MattermostWebSocketURL</span>, <span style=color:#a6e22e>AccessToken</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>appErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>appErr</span>.<span style=color:#a6e22e>Error</span>())
	}

  <span style=color:#75715e>// (4) 接続
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>appErr</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Connect</span>(); <span style=color:#a6e22e>appErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>appErr</span>.<span style=color:#a6e22e>Error</span>())
	}
	<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Listen</span>()

	<span style=color:#66d9ef>for</span> {
		<span style=color:#66d9ef>select</span> {
    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>event</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>EventChannel</span>:
      <span style=color:#75715e>// (5) WebSocket Eventについての処理
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Received: %v&#34;</span>, <span style=color:#a6e22e>event</span>)
		}
	}
}
</code></pre></div><p><code>(1)</code>でMattermost WebSocketのURLを宣言しています。プロトコルが<code>http(s)</code>ではなく<code>ws(s)</code>になります。また、WebSocket APIのエンドポイントは<code>/api/v4/websocket</code>ですが、この部分はMattermostのWebSocket Driverが付与してくれます。
<code>(2)</code>ではWebSocket APIにアクセスするために使用するアクセストークンを宣言しています。REST API実行用と同じTokenです。</p>
<p><code>(3)</code>で、MattermostのWebSocket Driverを利用してWebSocketクライアントを生成し、このクライアントを使って<code>(4)</code>でWebSocket APIへ接続しています。</p>
<p>接続が問題なく完了すると、 WebSocketクライアントの<code>EventChannel</code>フィールドにWebSocket Eventが流れてきます。<code>(5)</code>で、流れてきたイベントを出力しています。</p>
<p>上記コードを実行しておくと、Mattermost上で何か操作をした時にWebSocket Eventがコンソールに表示されるようになります。</p>
<p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day11/example-websocket-api.gif alt=video></p>
<p><code>Ctrl + c</code>を入力するとプログラムを終了します。</p>
<p>今回は単に受け取ったイベント情報を出力するだけでしたが、受け取った<a href=https://github.com/mattermost/mattermost-server/blob/c54ab6da211af861b25af1364518e549d3a1ed91/model/websocket_message.go#L109>WebSocketEvent</a>の内容に応じた処理を実装することもできます。
<code>WebSocketEvent</code>構造体の<code>Data</code>フィールドの内容はイベントの種類によって異なり、イベントの種類は下記から確認できます。
<a href=https://github.com/mattermost/mattermost-server/blob/c54ab6da211af861b25af1364518e549d3a1ed91/model/websocket_message.go#L14>https://github.com/mattermost/mattermost-server/blob/c54ab6da211af861b25af1364518e549d3a1ed91/model/websocket_message.go#L14</a></p>
<h2 id=websocket-apiの実行>WebSocket APIの実行</h2>
<p>MattermostではWebSocket APIを通じてリクエストを送信することもできるようですが、現在利用可能なのが下記3種類のみのようで、ちょっと用途が今のところ分かりません。</p>
<ul>
<li>user_typing</li>
<li>get_statuses</li>
<li>get_statuses_by_id</li>
</ul>
<h2 id=さいごに>さいごに</h2>
<p>Mattermost WebSocket APIの使い方について紹介しました。
明日は、Botアカウントの使い方を紹介します。</p>
<div class=blog-tags>
<a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/integration/>integration</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/api/>api</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/rest/>rest</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/websocket/>websocket</a>&nbsp;
</div>
</article>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<footer>
<div class=social-icons>
<a href=https://github.com/kaakaa name=GitHub>
<em class="fab fa-github-alt fa-lg"></em>
</a>
&nbsp;&ndash;&nbsp;
<a href=https://twitter.com/kaakaa_hoe_prog name=Twitter>
<em class="fab fa-twitter fa-lg"></em>
</a>
&nbsp;&ndash;&nbsp;
<a class=social-icon href=https://zenn.dev/kaakaa name=Zenn>
<img src=https://blog.kaakaa.dev/images/zenn.svg alt=Zenn>
</a>
&nbsp;&ndash;&nbsp;
<a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita>
<img src=https://blog.kaakaa.dev/images/qiita.png alt=Qiita>
</a>
</div>
<div class=container>
<p class="credits copyright">
<a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2023
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em>
</p>
<p class="credits theme-by">
Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a>
</p>
</div>
</footer>
</body>
</html>