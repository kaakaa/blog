<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8" />
<title>打ち合わせ みんな多忙で 草生えるwww</title>


  
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-57299975-4');
  </script>
  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://blog.kaakaa.dev/index.xml"
  title="kaakaa blog"
/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="打ち合わせ みんな多忙で 草生えるwww"/>
<meta name="twitter:description" content="字（草）余り。 この記事はFUJITSU Advent Calendar 2017 - Qiita 22日目の記事です。 記事の内容は全て個人の見解であり、執筆内容は執筆者自身の責任です。所属す"/>


  <meta property="og:title" content="打ち合わせ みんな多忙で 草生えるwww" />
<meta property="og:description" content="字（草）余り。 この記事はFUJITSU Advent Calendar 2017 - Qiita 22日目の記事です。 記事の内容は全て個人の見解であり、執筆内容は執筆者自身の責任です。所属す" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.kaakaa.dev/post/%E6%89%93%E3%81%A1%E5%90%88%E3%82%8F%E3%81%9B-%E3%81%BF%E3%82%93%E3%81%AA%E5%A4%9A%E5%BF%99%E3%81%A7-%E8%8D%89%E7%94%9F%E3%81%88%E3%82%8Bwww/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2017-12-21T13:49:26&#43;09:00" />
<meta property="article:modified_time" content="2017-12-21T13:49:26&#43;09:00" />




<link rel="stylesheet" href="https://blog.kaakaa.dev/fontawesome/css/all.min.css" />

<link
  id="dark-mode-theme"
  rel="stylesheet"
  href="https://blog.kaakaa.dev/css/dark.css"
/>

<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')
  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>

<script src="https://blog.kaakaa.dev/js/main.bundle.js"></script>
<script src="https://blog.kaakaa.dev/js/instantpage.min.js" type="module" defer></script>
<meta name="generator" content="Hugo 0.82.0" />
  </head>
  <body>
    
  




  <header>
    <nav class="navbar">
  <div class="nav">
    
      <a href="https://blog.kaakaa.dev/" class="nav-logo">
        <img
          src="https://blog.kaakaa.dev/images/icon.png"
          width="50"
          height="50"
          alt="Logo"
        />
      </a>
    

    <ul class="nav-links">
      
        
          <li>
            <a href="/" id="Home"
              ><em class="fas fa-home fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/about/" id="About"
              ><em class="fas fa-user fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/tags/" id="Tags"
              ><em class="fas fa-tag fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/search/" id="Search"
              ><em class="fas fa-search fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/index.xml" id="Subscribe"
              ><em class="fas fa-rss fa-lg"></em
            ></a>
          </li>
          
      
    </ul>
  </div>
</nav>

    <div class="intro-header">
      <div class="container">
        <div class="post-heading">
          
            <h1>
              打ち合わせ みんな多忙で 草生えるwww
            </h1>
          
          
            <span class="meta-post">
  <em class="fa fa-calendar-alt"></em
  >&nbsp;Dec 21, 2017
  
</span>

          
        </div>
      </div>
    </div>
  </header>
  

    
  <div class="container" role="main">
    <article class="article" class="blog-post">
      <p>字（草）余り。</p>
<hr>
<p>この記事は<a href="https://qiita.com/advent-calendar/2017/fujitsu">FUJITSU Advent Calendar 2017 - Qiita</a> 22日目の記事です。
記事の内容は全て個人の見解であり、執筆内容は執筆者自身の責任です。所属する組織は関係ありません。</p>
<h1 id="はじめに">はじめに</h1>
<p>打ち合わせの調整を依頼されて、みんな多忙で入れる隙間も無いと草生えますよね。</p>
<p><strong>生やしましょう。</strong></p>
<h1 id="mattermostでスケジュール可視化調整">Mattermostでスケジュール可視化&amp;調整</h1>
<p><a href="https://qiita.com/kaakaa_hoe/items/7fd95171f38dc3178276">去年に引き続き</a>Mattermostネタです。
(去年は技術記事じゃなかったことを反省しながら)</p>
<p>MattermostはMattermost Inc.社が開発しているSlack AlternativeなOSSのチャットツールです。
<a href="https://about.mattermost.com/">https://about.mattermost.com/</a>
<a href="https://github.com/mattermost">https://github.com/mattermost</a></p>
<hr>
<p>Mattermostの<a href="https://docs.mattermost.com/developer/interactive-message-buttons.html">Interactive Message Button</a>使って何か作りたくて、スケジュール可視化&amp;チャットから会議予約なモノを作りかけました。</p>
<p><a href="https://github.com/kaakaa/matter-meeting">kaakaa/matter-meeting: [PoC] Sending meeting request to Exchange from Mattermost</a></p>
<p>実用的なところまで行き着けなかったので表現弱めに。コンセプト実装とお受け取りください。</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#概要">概要</a></li>
    <li><a href="#構成">構成</a></li>
  </ul>

  <ul>
    <li><a href="#mattermost">Mattermost</a>
      <ul>
        <li><a href="#custom-slash-command">Custom Slash Command</a></li>
        <li><a href="#interactive-message-button">Interactive Message Button</a></li>
      </ul>
    </li>
    <li><a href="#exchange">Exchange</a></li>
    <li><a href="#草生やす">草生やす</a></li>
    <li><a href="#minio">Minio</a></li>
    <li><a href="#テストは">テストは？</a></li>
    <li><a href="#コード品質は">コード品質は？</a></li>
    <li><a href="#問題">問題</a></li>
    <li><a href="#mattermostについて">Mattermostについて</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav><h2 id="概要">概要</h2>
<p>こんな感じで動きます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9891/ef605519-f446-3103-3d22-9c6dfbaf9366.gif" alt="user_genarated_image.gif"></p>
<p>Mattermostから打ち合わせ参加者のメアドを指定すると、現在から1週間後までの参加者全員のスケジュールをGitHubの草風に表示。さらにはInteractive Message Buttonから会議予約を飛ばすこともできたりします。</p>
<p>Exchangeから予定を取得にはEWSのGetUserAvailabilityというAPIを利用しており、このAPIが全員の予定の中から空いている時間を<code>quality</code>というフィールド付きで返してくれます。<a href="http://ews-javascript-api.github.io/api/enums/enumerations_suggestionquality.suggestionquality.html">SuggestionQuality | Ews JavaScript Api</a>。
<code>quality</code>はどうも0～3までの整数で表されるようなので、その値をそのまま草の濃淡として表示しています。</p>
<p>草の色は白に近いほど皆の予定が空いており、緑が濃いほど予定が詰まっていることを示しています。</p>
<p>つまり、<strong>みんな忙しいと草生えるwww</strong>
（深夜帯が草だらけなのは実装の都合上です。要検討事項。）</p>
<h2 id="構成">構成</h2>
<p>ざっくりこんな構成で動いてます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9891/0caf8739-e4cd-1b17-cf15-7eab5c953f3f.png" alt="Architecture.png"></p>
<p>Slash Commandからリクエストを受けると、Exchange Serverへ問い合わせをし、そのレスポンスからMattermostへのBot投稿と草用のSVG画像を生成。
Bot投稿のボタンを押すと、Exchangeへ会議予約のリクエストが送られるという感じ。</p>
<p>Exchangeサーバーに繋ぐ部分にews-javascript-apiを使ってるのに引きずられて、慣れないNode.js使ってるのでPromiseの使い方がとても怪しい。
（そして型がない言語だからか、コード書いててもmodelが生えない…草は生えるのに…）</p>
<h1 id="要素技術の紹介">要素技術の紹介</h1>
<h2 id="mattermost">Mattermost</h2>
<h3 id="custom-slash-command">Custom Slash Command</h3>
<p>Mattermostでは自作の<a href="https://docs.mattermost.com/developer/slash-commands.html#custom-slash-command">Slash Commands</a>を登録できます。
少し前にこれを使って<a href="https://qiita.com/kaakaa_hoe/items/b2605ce3816cfc517ecd">投票機能</a>みたいなのも作ってました。</p>
<p>今回は自作Slash Commandsサーバーのレスポンスに<a href="https://docs.mattermost.com/developer/message-attachments.html">Messsage Attachments</a>を使用し、ちょっとリッチなフォーマットで反応できるようにしています。</p>
<p>Message Attachmentsは、Slash Commandsのレスポンスとして下記のようなJSONをMattermostに返すと</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;attachments&#34;</span>: [
    {
      <span style="color:#f92672">&#34;fallback&#34;</span>: <span style="color:#e6db74">&#34;test&#34;</span>,
      <span style="color:#f92672">&#34;color&#34;</span>: <span style="color:#e6db74">&#34;#FF8000&#34;</span>,
      <span style="color:#f92672">&#34;pretext&#34;</span>: <span style="color:#e6db74">&#34;This is optional pretext that shows above the attachment.&#34;</span>,
      <span style="color:#f92672">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;This is the text of the attachment. It should appear just above an image of the Mattermost logo. The left border of the attachment should be colored orange, and below the image it should include additional fields that are formatted in columns. At the top of the attachment, there should be an author name followed by a bolded title. Both the author name and the title should be hyperlinks.&#34;</span>,
      <span style="color:#f92672">&#34;author_name&#34;</span>: <span style="color:#e6db74">&#34;Mattermost&#34;</span>,
      <span style="color:#f92672">&#34;author_icon&#34;</span>: <span style="color:#e6db74">&#34;http://www.mattermost.org/wp-content/uploads/2016/04/icon_WS.png&#34;</span>,
      <span style="color:#f92672">&#34;author_link&#34;</span>: <span style="color:#e6db74">&#34;http://www.mattermost.org/&#34;</span>,
      <span style="color:#f92672">&#34;title&#34;</span>: <span style="color:#e6db74">&#34;Example Attachment&#34;</span>,
      <span style="color:#f92672">&#34;title_link&#34;</span>: <span style="color:#e6db74">&#34;http://docs.mattermost.com/developer/message-attachments.html&#34;</span>,
      <span style="color:#f92672">&#34;fields&#34;</span>: [
        {
          <span style="color:#f92672">&#34;short&#34;</span>: <span style="color:#66d9ef">false</span>,
          <span style="color:#f92672">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Long Field&#34;</span>,
          <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;Testing with a very long piece of text that will take up the whole width of the table. And then some more text to make it extra long.&#34;</span>
        },
        {
          <span style="color:#f92672">&#34;short&#34;</span>:<span style="color:#66d9ef">true</span>,
          <span style="color:#f92672">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Column One&#34;</span>,
          <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;Testing&#34;</span>
        },
        {
          <span style="color:#f92672">&#34;short&#34;</span>:<span style="color:#66d9ef">true</span>,
          <span style="color:#f92672">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Column Two&#34;</span>,
          <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;Testing&#34;</span>
        },
        {
        <span style="color:#f92672">&#34;short&#34;</span>:<span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Another Field&#34;</span>,
        <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;Testing&#34;</span>
        }
      ],
      <span style="color:#f92672">&#34;image_url&#34;</span>: <span style="color:#e6db74">&#34;http://www.mattermost.org/wp-content/uploads/2016/03/logoHorizontal_WS.png&#34;</span>
    }
  ]
}
</code></pre></div><p>こんな感じの投稿を作ってくれます。</p>
<img width="723" alt="attachments-example.png" src="https://qiita-image-store.s3.amazonaws.com/0/9891/b05ada9b-1dcd-2278-30df-50019b8194cd.png">
<p>(参考: <a href="https://docs.mattermost.com/developer/message-attachments.html#example-message-attachment">Message Attachments — Mattermost 4.5 documentation</a>)</p>
<p>メッセージが5行以上の時は省略表示もしてくれるのも良い感じです。
最近、Mattermostのコアチームを真似てGHEのアクティビティをMattermostに流したりしてるのですが、コレを使うと長いIssueでも良い感じに表示してくれるので気に入ってます。</p>
<h3 id="interactive-message-button">Interactive Message Button</h3>
<p>ChatOps黎明期のBotはメッセージを投稿するだけでしたが、最近のBotはメッセージに選択肢を付けてくれます。
Slackには昔からある機能みたいで、<a href="http://tech.mercari.com/entry/2017/05/23/095500">GolangでSlack Interactive Messageを使ったBotを書く - Mercari Engineering Blog</a>を見ながら面白そうだな～なんて思ってたら、Mattermostにもやってきました。（<a href="https://github.com/mattermost/mattermost-server/pull/7274">PLT-6403: Interactive messages by ccbrown</a>）。
Mattermostでは今のところボタンのみの対応ですが。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9891/20500a8d-92bf-f3cc-13fd-8607185bb859.gif" alt="poll.gif">
（参考: <a href="https://docs.mattermost.com/developer/interactive-message-buttons.html">Interactive Message Buttons (Beta) — Mattermost 4.5 documentation</a>）</p>
<p>今回は、調整した予定の中でもっとも参加可能人数が多い時間をInteractive Message Buttonとして表示しています。多すぎると訳分からなくなりそうだったので最大１０個まで表示。
ボタンを押すと会議出席依頼が飛ばせるというアレ。べんり。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9891/f193c0f2-fd3d-6eaa-21ba-b62b395864af.png" alt="meeting2_0.png"></p>
<p>Interactive Message Buttonの作り方は、先述のMessage Attachmentsのレスポンスの中に<a href="https://docs.mattermost.com/developer/interactive-message-buttons.html#button-options"><code>integration</code></a>というフィールドとして指定することで作れます。</p>
<p>んで、ボタンを押すとhttpリクエストが飛ばされるというアレ。夢が広がりますね。はい。</p>
<p>ボタンだけでも十分遊べそうですが、セレクトボックスとかチェックボックスなんかも加わると更に夢が広がりそうだなぁ。まとまった時間とってコントリビュートしたいなぁ。</p>
<h2 id="exchange">Exchange</h2>
<p>予定の取得や会議予約を飛ばしたりするのは<a href="https://github.com/gautamsi/ews-javascript-api">ews-javascript-api</a>を使っています。
昔は<a href="https://github.com/OfficeDev/ews-java-api">ews-java-api</a>を使って遊んでいましたが、歳のせいかJavaを書くのが辛くなってきました。</p>
<p>ews-javascript-apiはユースケース情報が転がってない気がするので、こんな感じで増やしていけると良いですね。</p>
<p>ただ、これ便利なんですが、気を許すと全社員宛のリクエストを飛ばすことになりかねなかったりするので、指定できるメアドにはホワイトリスト方式を採用しています。<strong>マジでここだけ注意な。</strong></p>
<p>一応設定ファイルで正規表現指定できるけど、仲間内のメアドだけリストで指定しておくのが安全です。ews-javascript-api使って自分の部門だけに制限するとかも出来る…のかな？</p>
<h2 id="草生やす">草生やす</h2>
<p>サーバー側でnunchucks テンプレートにスケジュール情報を流し込み、SVG作ってOSSのS3互換オブジェクトストレージである<a href="https://minio.io/">Minio</a>に投げてます。
ここで生成した草画像はMattermostのMessage Attachmentsの<a href="https://docs.mattermost.com/developer/message-attachments.html#images"><code>image_url</code></a>に指定して表示させてます。</p>
<p>最初はsvg2png使って画像ファイル化してたけど、Message Attachmentsで指定したURLは<a href="https://github.com/mattermost/mattermost-webapp/blob/master/components/post_view/post_attachment.jsx#L303"><code>img</code>タグで読み込んでる</a>ようなので、SVGのままでも行けるじゃん、と後で気づきました。</p>
<h2 id="minio">Minio</h2>
<p>生成したSVGは、上述のようにMinioに格納してURL指定で取得できるようにしています。
スラッシュコマンドを実行するごとに<a href="https://www.npmjs.com/package/shortid">shortid</a>でユニークIDらしき物を作って、そのIDをファイル名としてSVGを保存してます。</p>
<p>SVGはローカルファイルとして格納しても良いかとも思ったのですが、なんとなくMinioを使ってみたかったので。
一定時間経ったSVGは削除するソリューションも欲しくなってます。</p>
<p>Minioだと少しヘビーな気がするのと、ランダム文字列とはいえ誰でも見えるところに調整結果の画像を置くのは少し忍びない気もしていますが、まぁとりあえず。</p>
<h2 id="テストは">テストは？</h2>
<p>まだ無い</p>
<h2 id="コード品質は">コード品質は？</h2>
<p>嘲笑するならパッチくれ</p>
<h2 id="問題">問題</h2>
<p>実用に向けた最大の課題は、ews-javascript-api使うために指定したアカウントからしか会議出席依頼を飛ばせないところ。みんなで使うと私のスケジュールが凄いことになりそう。
Bot社員が求められている。</p>
<p>あと細々した改善点もたくさん。</p>
<ul>
<li>30分間の予定しか想定されてない</li>
<li>現在から1週間後までの間しか調べてない(日時指定できるようにするとコマンドが複雑になるのがアレ)</li>
<li>メアド毎回入力するのが面倒 (Mattermostの@channel使うとチャンネル内全員対象にする、とか出来ると理想)</li>
</ul>
<p>などなど。
今回用のネタとして開発したものなので突き詰めるつもりもないですが(たぶん)</p>
<h2 id="mattermostについて">Mattermostについて</h2>
<p>最近、UberがSlack/HipChatを諦めてMattermostベースのコミュニケーションプラットフォームである<code>uChau</code>というのを作り始めているというニュースがあり。まだまだユーザー数を伸ばしていきそうな感じがします。
<a href="https://eng.uber.com/uchat/">The Road to uChat: Building Uber’s Internal Chat Solution</a></p>
<p>機能的にも、この記事でも取り扱ったInteractive Message Buttonや、<a href="https://docs.mattermost.com/administration/plugins.html">Plugins機能</a>なんかも追加されてきているので、まだまだいろいろ遊べるようになっていく予感。</p>
<p>開発も活発なのでこれからも期待しています。</p>
<h2 id="おわりに">おわりに</h2>
<p>お仕事ではみんなで大草原回避しましょう。</p>



      
        <div class="blog-tags">
          
            <a
              href="https://blog.kaakaa.dev/tags/node.js/"
              >Node.js</a
            >&nbsp;
          
            <a
              href="https://blog.kaakaa.dev/tags/chatops/"
              >ChatOps</a
            >&nbsp;
          
            <a
              href="https://blog.kaakaa.dev/tags/%E4%BC%9A%E8%AD%B0/"
              >会議</a
            >&nbsp;
          
            <a
              href="https://blog.kaakaa.dev/tags/mattermost/"
              >Mattermost</a
            >&nbsp;
          
            <a
              href="https://blog.kaakaa.dev/tags/ews/"
              >ews</a
            >&nbsp;
          
        </div>
      
    </article>
    
    
      
  <div id="disqus_thread"></div>
  <script type="text/javascript">
        (function() {
            
            
            if (window.location.hostname == "localhost") return;

            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            var disqus_shortname = 'kaakaa-blog';
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
  <noscript
    >Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript"
      >comments powered by Disqus.</a
    ></noscript
  >
  <a href="https://disqus.com/" class="dsq-brlink"
    >comments powered by <span class="logo-disqus">Disqus</span></a
  >


    
  </div>

    <footer>
  

<div class="social-icons">
  
    
    
      
      <a href="https://github.com/kaakaa" name="GitHub">
        <em class="fab fa-github-alt fa-lg"></em>
      </a>
    
       &nbsp;&ndash;&nbsp;
      <a href="https://twitter.com/kaakaa_hoe_prog" name="Twitter">
        <em class="fab fa-twitter fa-lg"></em>
      </a>
    
  

  
    
    
       &nbsp;&ndash;&nbsp; 
      <a class="social-icon" href="https://zenn.dev/kaakaa" name="Zenn">
        <img
          src="https://blog.kaakaa.dev/images/zenn.svg"
          alt="Zenn"
        />
      </a>
    
       &nbsp;&ndash;&nbsp; 
      <a class="social-icon" href="https://twitter.com/kaakaa_hoe_prog" name="Qiita">
        <img
          src="https://blog.kaakaa.dev/images/qiita.png"
          alt="Qiita"
        />
      </a>
    
  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://blog.kaakaa.dev/about">Yusuke Nemoto</a>
      &nbsp;&copy;
      2022
      
        &nbsp;/&nbsp;
        <a href="https://blog.kaakaa.dev/">kaakaa blog</a>
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
  </div>
</footer>

  </body>
</html>
