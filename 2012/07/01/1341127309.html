<!DOCTYPE html>
<html>
  <head>
    <title>
      KS Sample
    </title>
    <meta chearset="UTF-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <link href="/css/kickstart.css" media="all" rel="stylesheet" type="text/css" />
    <link href="/style.css" media="all" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/kickstart.js" type="text/javasript"></script>
  </head>
  <body class="elements">
    <div class="callout clearfix">
      <h1>
        びぼーろく（仮）
      </h1>
      <div class="grid">
        <div class="col_12">
          <ul class="tabs right">
            <li>
              <a href="tab_blog"><i class="icon-file"></i>BLOG</a>
            </li>
            <li>
              <a href="tab_socials"><i class="icon-twitter"></i>SOCIALS</a>
            </li>
            <li>
              <a href="https://github.com/kaakaa/middleman-blog-slim-sample/tree/gh-pages"><i class="icon-github"></i>View on Gitub</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="grid">
      <div class="col_12"><p>Jenkinsプラグイン拡張を勉強中。</p>

<p>うちの組織では「ソースコードの規模に対して◯件エラーが出るはずだ」という指標値があります。</p>

<p>予め指標値を入力しておけば、ステップカウンターで測定したステップ数を元に自動的に目標エラー件数を計算して表示してくれるプラグインを作っていきたいと思います。</p>

<p>「対ステップ数のエラー件数指標値なんて何の意味があるのか」という異論・反論は受け付けません。</p>

<p>\
 \</p>

<p>まずは、Jenkinsの公式などを参考にHelloWorldBuilderプラグインを生成。</p>

<p><a href="https://wiki.jenkins-ci.org/display/JA/Plugin+tutorial">Plugin tutorial - 日本語 - Jenkins
Wiki</a></p>

<p>今回プラグイン名などは以下のようにしました。</p>

<p>groupId : my.plugin</p>

<p>artifactId : MyPlugin</p>

<p>\</p>

<p>出来上がったプラグインのsrcディレクトリ配下は以下の様な構成になっているはずです。</p>

<pre><code>src
┗main
　┣java
  ┃┗my
  ┃　┗plugin
  ┃　　┗HelloWorldBuilder.java   
  ┗resources
　　┣index.jelly
　　┗my
　　　┗plugin
　　　　┗HelloWorldBuilder
　　　　　┣config.jelly
　　　　　┣global.jelly
　　　　　┣help-name.html
　　　　　┗help-useFrench.html
</code></pre>

<p>\</p>

<p>HelloWorldBuilderプラグインの処理を記述してあるのが、HelloWorldBuilder.java。</p>

<p>コンフィグ画面を記述しているのがresources以下のHelloWorldBuilderディレクトリにあるjellyファイル達です。</p>

<p>config.jellyとglobal.jellyの２ファイルがあります。</p>

<p>Jenkinsトップ→「Jenkinsの管理」→「システムの設定」の設定画面でのコンフィグ画面を記述するのがglobal.jelly。</p>

<p>各ジョブ画面→「設定」の設定画面でのコンフィグ画面を記述するのがconfig.jelly。</p>

<p>今回global.jellyファイルはいじりません。</p>

<p>\</p>

<p>さて、HelloWorldBuilder.javaはhudson.tasks.Builderクラスを継承したクラスになっています。</p>

<p>これはHelloWorldBuilderプラグインがジョブのビルド時に動作するプラグインであるということです。</p>

<p>なので、HelloWorldBuilderプラグインの設定項目は「ビルド」セクションで選べるようになっています。</p>

<p>画像の"Say Hello World"がHelloWorldBuilderプラグインの設定項目です。</p>

<p><a href="http://f.hatena.ne.jp/kaakaa_hoe/20120701154526"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/k/kaakaa_hoe/20120701/20120701154526.png" alt="f:id:kaakaa\_hoe:20120701154526p:image" title="f:id:kaakaa_hoe:20120701154526p:image" /></a></p>

<p>今回作りたいプラグインは、ビルドによって生成されるStepcounterの出力ファイルを利用するため、設定項目は「ビルド後の処理」セクションで選べるようになって欲しいはずです。</p>

<p>そのためには、hudson.tasks.Notifierクラスを継承したクラスを作成すれば良いです。</p>

<p>hudson.tasks.Notifierクラスを継承したクラスの設定項目は「ビルド後の処理」セクションの設定項目として現れます。</p>

<p>そこで、Notifierクラスを継承したCalculatorTestIndexValueクラスを作成します。</p>

<p>CalculatorTestIndexValue.java</p>

<p>~~~~ {.syntax-highlight}
package my.plugin;</p>

<p>import hudson.Extension;
import hudson.model.AbstractProject;
import hudson.tasks.BuildStepDescriptor;
import hudson.tasks.BuildStepMonitor;
import hudson.tasks.Notifier;
import hudson.tasks.Publisher;</p>

<p>public class CalcuratorTestIndexValue extends Notifier {</p>

<pre><code>public BuildStepMonitor getRequiredMonitorService() {
    return null;
}

@Extension
public static final class DescriptorImpl extends
        BuildStepDescriptor&lt;Publisher&gt; {

    private String jenkinsUserName;

    @Override
    public boolean isApplicable(Class&lt;? extends AbstractProject&gt; jobType) {
        return true;
    }

    @Override
    public String getDisplayName() {
        return "Calc Test Index Value";
    }
}
</code></pre>

<p>}
~~~~</p>

<p>ここで、内部クラスDesciptorImplを作成していますが、DescriptorImplクラスのgetDisplayNameメソッドを作成しないと、プラグインの設定項目が出て来ません。</p>

<p>上記のようにCalcuratorTestIndexValue.javaを作成することで、「ビルド後の処理」セクションに設定項目"Cals
Test Index value"が出現します。</p>

<p><a href="http://f.hatena.ne.jp/kaakaa_hoe/20120701155830"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/k/kaakaa_hoe/20120701/20120701155830.png" alt="f:id:kaakaa\_hoe:20120701155830p:image" title="f:id:kaakaa_hoe:20120701155830p:image" /></a></p>

<p>設定項目にチェックボックスだったりテキストエリアを付けるには、resources配下にmy/plugin/CalcuratorTestIndexValueディレクトリを作って、その下にconfig.jellyを作成します。</p>

<p>Jellyについてはもう少し勉強が必要なので割愛。</p>

<p>ココらへんが参考になりそう。</p>

<p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Jelly+form+controls">Jelly form controls - Jenkins - Jenkins
Wiki</a></p>

<p><a href="http://jenkins-ci.org/maven-site/hudson-core/jelly-taglib-ref.html">Hudson core - Jelly Taglib
references</a></p>

<p>\</p>

<p>設定についてはコレぐらいにして、次は処理について。</p>

<p>先ほど作成したCalcuratorTestIndexValue.javaに処理を記述する訳ですが、このままでは動きません。</p>

<p>performメソッドをオーバーライドし、そこに処理を記述していきます。</p>

<p>~~~~ {.syntax-highlight}</p>

<pre><code>@Override
public boolean perform(AbstractBuild&lt;?, ?&gt; build, Launcher launcher,
        BuildListener listener) throws InterruptedException, IOException {
    return super.perform(build, launcher, listener);
} ~~~~
</code></pre>

<p>とりあえず、ココまで。</p>

<p>びぼーろく</p>

<ul>
  <li>build.getWorkspace()でジョブのパスを取得することが出来る。</li>
</ul>

<p><a href="http://b.hatena.ne.jp/entry/http://d.hatena.ne.jp" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" /></a></p>

<p><a href="http://twitter.com/share">ツイートする</a></p>

      </div>
      <hr />
      <div class="col_12">
        <div class="col_4">
          <h4>
            Profile
          </h4>
          <img class="align-center" src="http://placehold.it/169x130/4D99E0/ffffff.png&text=full+width" />
          <p>
            live in Yokohama. Software Engineer. Java / Groovy / Ruby / Sinatra / Trac / Jenkins
          </p>
        </div>
        <div class="col_5">
          <h5>
            Recent Articles
          </h5>
          <ul class="alt">
            <li>
              <a href="/2013/10/10/webfrontier_seminar.html">2013年秋 Web開発最前線テックトーク</a>
            </li>
            <li>
              <a href="/2013/10/07/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/10/06/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/10/05/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/09/24/1380029870.html">Githubリポジトリのデフォルトブランチを変更する</a>
            </li>
            <li>
              <a href="/2013/09/15/20130915.html">Sinatraアプリを定期的に実行するために泥臭く行ってみた</a>
            </li>
            <li>
              <a href="/2013/09/10/20130910.html">Node.js(Express)でフィードアグリゲータを作り始め</a>
            </li>
            <li>
              <a href="/2013/09/03/20130903.html">SinatraでFeedAggregator</a>
            </li>
            <li>
              <a href="/2013/08/19/1376919346.html">社内勉強会 - 書籍管理Webシステム</a>
            </li>
            <li>
              <a href="/2013/07/18/1374154333.html">Gitbucket1.2で500エラー</a>
            </li>
            <li>
              <a href="/2013/06/24/20130624.html">社内勉強会 - chef</a>
            </li>
          </ul>
        </div>
        <div class="col_3">
          <h5>
            By Year
          </h5>
          <ul class="alt">
            <li>
              <a href="/2013.html">2013</a>(25)
            </li>
            <li>
              <a href="/2012.html">2012</a>(81)
            </li>
            <li>
              <a href="/2011.html">2011</a>(31)
            </li>
          </ul>
        </div>
      </div>
    </div>
    <hr />
    <div class="footer">
      <p>
        &copy; Copyright 2013 kaakaa
      </p>
    </div>
  </body>
</html>