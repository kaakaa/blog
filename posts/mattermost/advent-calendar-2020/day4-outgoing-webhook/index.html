<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>[Mattermost Integrations] Outgoing WebHook 基本編</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="[Mattermost Integrations] Outgoing WebHook 基本編"><meta name=twitter:description content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第4日目の記事です。 本記事では、Matt"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links><li><a href=/ id=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>[Mattermost Integrations] Outgoing WebHook 基本編</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>Mattermost記事まとめ: <a href=https://blog.kaakaa.dev/tags/mattermost/>https://blog.kaakaa.dev/tags/mattermost/</a></p><nav id=TableOfContents><ul><li><a href=#本記事について>本記事について</a></li><li><a href=#outgoing-webhook概要>Outgoing WebHook概要</a><ul><li><a href=#設定>設定</a></li><li><a href=#作成>作成</a></li><li><a href=#実行>実行</a></li></ul></li><li><a href=#さいごに>さいごに</a></li></ul></nav><h2 id=本記事について>本記事について</h2><p><a href=https://qiita.com/advent-calendar/2020/mattermost-integrations>Mattermostの統合機能アドベントカレンダー</a>の第4日目の記事です。</p><p>本記事では、Mattermostから外部アプリケーションへ投稿内容を送信できるOutgoing WebHook（外向きのウェブフック）について紹介します。</p><h2 id=outgoing-webhook概要>Outgoing WebHook概要</h2><p>Outgoing WebHookは、Mattermostに投稿が作成された時にその投稿情報を外部アプリケーションへ送信するための機能です。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/overview.drawio.png alt=overview></p><p>Outgoing WebHookを使うことで、Mattermostで発生した投稿イベントを外部アプリケーションに通知することができます。</p><p>Outgoing WebHookに関する公式ドキュメントは下記になります。</p><ul><li><a href=https://docs.mattermost.com/developer/webhooks-outgoing.html>https://docs.mattermost.com/developer/webhooks-outgoing.html</a></li><li><a href=https://developers.mattermost.com/integrate/outgoing-webhooks/>https://developers.mattermost.com/integrate/outgoing-webhooks/</a></li></ul><p>一つ目の公式ドキュメントはOutgoing WebHookの概要について記述しており、二つ目のDeveloper Documentにはより細かい開発者向けの情報が書かれています。</p><h3 id=設定>設定</h3><p>Outgoing WebHookを利用するには、<strong>システムコンソール > 統合機能管理 > 外向きのウェブフックを有効にする</strong> の設定が<code>有効</code>になっている必要があります。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/config-outgoing-webhook.png alt="system console"></p><p>また、統合機能はデフォルトではシステム管理者とチーム管理者しか作成することができませんが、誰でも作成できるようにしたい場合、<strong>システムコンソール > 統合機能管理 > 統合機能の管理を管理者のみに制限する</strong>の設定を<code>無効</code>してください。</p><h3 id=作成>作成</h3><p><strong>メインメニュー > 統合機能</strong>から統合機能の画面を開き、</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/integration-menu.png alt="main menu"></p><p><strong>外向きのウェブフック > 外向きのウェブフックを追加する</strong>から、新たなOutgoing WebHookを追加します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/outgoing-webhook-menu.png alt=menu></p><p>ウェブフックの作成画面で入力する情報は下記の通りです。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/create-outgoing-webhook.png alt="outgoing webhook"></p><ul><li><strong>タイトル</strong>: ウェブフックの一覧ページに表示されるタイトルです</li><li><strong>説明</strong>: ウェブフックの説明です</li><li><strong>コンテントタイプ</strong>: 外部アプリケーションに送信するデータの形式を<code>application/x-www-form-urlencoded</code> と <code>application/json</code> から選択できます</li><li><strong>チャンネル</strong>: ここで指定したチャンネルに投稿が作成されると、外部アプリケーションへのリクエストが送信されます。トリガーワードを指定した場合、チャンネルの指定は必須ではなくなります。非公開チャンネルやダイレクトメッセージチャンネルは指定できません。</li><li><strong>トリガーワード</strong>: ここで指定したキーワードで始まる投稿が外部アプリケーションへ送信されます。チャンネルとトリガーワードを両方指定した場合、指定したチャンネル内のトリガーワードで始まる投稿のみが外部アプリケーションに送信されます。</li><li><strong>トリガーとなる条件</strong>: トリガーワードと一致する条件を指定します。スペース区切りで最初の単語がトリガーワードと完全に一致するか、トリガーワードで始まるかを設定するものであるため、日本語の投稿を対象とする場合、<code>最初の単語がトリガーワードで始まる</code>に設定しておくと良いかと思います。</li><li><strong>コールバックURL</strong>: リクエスト送信先のURLです。</li></ul><p>Outgoing WebHookの作成が完了すると、トークンが表示されます。このトークンは、外部アプリケーションに対して送信されるリクエストに含まれる値であり、リクエストがMattermostから送信されたことを検証するために使われます。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/complete-outgoing-webhook.png alt=complete></p><h3 id=実行>実行</h3><p>Outgoing WebHookを実行する前に、リクエスト送信先サーバーを立ち上げておく必要があります。
今回は、送信されたリクエストのJSONボディをログ出力する簡単なサーバーを立ち上げておきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go:main.go data-lang=go:main.go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
	<span style=color:#e6db74>&#34;log&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>

	<span style=color:#e6db74>&#34;github.com/mattermost/mattermost-server/v5/model&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/outgoing&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
		<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
		<span style=color:#75715e>// (1) `model.OutgoingWebhookPayload`によるリクエストの読み出し
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>OutgoingWebhookPayload</span>
		<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>)

    	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Request: %#v&#34;</span>, <span style=color:#a6e22e>payload</span>)
  })
  
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><p><code>(1)</code> Outgoing WebHookにより送信されるJSONデータは、Mattermost本体の <a href=https://github.com/mattermost/mattermost-server/blob/master/model/outgoing_webhook.go#L35><code>model.OutgoingWebhookPayload</code></a> の形式で送信されるため、この構造体を利用してデータを変換しています。</p><p>上記コードを<code>main.go</code>として保存し、<code>go run main</code>を実行してサーバーを立ち上げます。MattermostサーバーとOutgoing WebHookリクエスト受付用のサーバを同じマシン上で起動し、Outgoing WebHook作成時の<strong>コールバックURL</strong>に<code>localhost</code>のサーバーを指定している場合、<strong>システムコンソール > 開発者 > 信頼されていない内部接続を許可する</strong>に<code>localhost</code>を追加しておく必要があります。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/config-allow-internal.png alt="config allow internal"></p><p>上記の設定が完了した後、Outgoing WebHook作成時に<strong>チャンネル</strong>に指定したチャンネルに投稿を作成すると、</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day4/trigger-outgoing-webhook.png alt=trigger></p><p>Outgoing WebHookがサーバに送信され、下記のようなリクエストの情報がコンソールに出力されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ go run main.go 
2020/11/03 00:10:30 Request: model.OutgoingWebhookPayload<span style=color:#f92672>{</span>Token:<span style=color:#e6db74>&#34;9mgpebi9a7bq3qjedd1kt6mwtr&#34;</span>, TeamId:<span style=color:#e6db74>&#34;9d1xf4gg7fnibxs8fdw6fo5fre&#34;</span>, TeamDomain:<span style=color:#e6db74>&#34;test&#34;</span>, ChannelId:<span style=color:#e6db74>&#34;9eexapjuabd89fzbwfajdqhwta&#34;</span>, ChannelName:<span style=color:#e6db74>&#34;outgoing-webhook&#34;</span>, Timestamp:1604329830865, UserId:<span style=color:#e6db74>&#34;87x93uo8pfnzdro9ktcmobpa1r&#34;</span>, UserName:<span style=color:#e6db74>&#34;kaakaa&#34;</span>, PostId:<span style=color:#e6db74>&#34;au6tf4hoebyeffiaw9h1w6rpaw&#34;</span>, Text:<span style=color:#e6db74>&#34;こんにちは、テスト。&#34;</span>, TriggerWord:<span style=color:#e6db74>&#34;こんにちは、&#34;</span>, FileIds:<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}</span>
</code></pre></div><p>リクエストに含まれるトークンの値(<code>Token:"9mgpebi9a7bq3qjedd1kt6mwtr"</code>)がOutgoing WebHook作成時に表示されていたトークンと同じものであることがわかります。</p><p>このように、Mattermostの投稿情報を外部アプリケーションへ送信することができます。外部アプリケーション側で、送信されたリクエストに応じた処理を実装することで、Mattermostから処理を起動したりすることができます。また、ウェブフックを受け取った外部アプリケーションから、再びMattermostへ投稿を作成したりすることもできますが、その辺りは明日の記事で紹介します。</p><h2 id=さいごに>さいごに</h2><p>本日は、Outgoing WebHookの基本的な使い方について紹介しました。
明日は、Outgoing WebHookに反応して外部アプリケーションからMattermostへ投稿を作成する方法について紹介します。</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/integration/>integration</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/webhook/>webhook</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/outgoing/>outgoing</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://github.com/kaakaa name=GitHub><em class="fab fa-github-alt fa-lg"></em></a><a href=https://twitter.com/kaakaa_hoe_prog name=Twitter><em class="fab fa-twitter fa-lg"></em></a><a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita><img src=https://blog.kaakaa.dev/images/qiita.png width=20 height=20 alt=Qiita></a></div><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>