<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>[Mattermost Integrations] Plugin (Webapp 2)</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="[Mattermost Integrations] Plugin (Webapp 2)"><meta name=twitter:description content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第21日目の記事です。 昨日に引き続き、M"><meta property="og:title" content="[Mattermost Integrations] Plugin (Webapp 2)"><meta property="og:description" content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第21日目の記事です。 昨日に引き続き、M"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaakaa.dev/posts/mattermost/advent-calendar-2020/day21-plugin-webapp2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-21T00:00:00+09:00"><meta property="article:modified_time" content="2020-12-21T00:00:00+09:00"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><a href=https://blog.kaakaa.dev/ class=nav-logo><img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/ id=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>[Mattermost Integrations] Plugin (Webapp 2)</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>Mattermost記事まとめ: <a href=https://blog.kaakaa.dev/tags/mattermost/>https://blog.kaakaa.dev/tags/mattermost/</a></p><nav id=TableOfContents><ul><li><a href=#本記事について>本記事について</a></li><li><a href=#webapp-plugin-api>Webapp Plugin API</a><ul><li><a href=#registerwebsocketeventhandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterwebsocketeventhandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler>registerWebSocketEventHandler</a></a></li><li><a href=#unregisterwebsocketeventhandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisterwebsocketeventhandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterWebSocketEventHandler>unregisterWebSocketEventHandler</a></a></li><li><a href=#registerreconnecthandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterreconnecthandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerReconnectHandler>registerReconnectHandler</a></a></li><li><a href=#unregisterreconnecthandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisterreconnecthandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterReconnectHandler>unregisterReconnectHandler</a></a></li><li><a href=#registermessagewillbepostedhookhttpsdevelopersmattermostcomextendpluginswebappreferenceregistermessagewillbepostedhook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillBePostedHook>registerMessageWillBePostedHook</a></a></li><li><a href=#registerslashcommandwillbepostedhookhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterslashcommandwillbepostedhook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerSlashCommandWillBePostedHook>registerSlashCommandWillBePostedHook</a></a></li><li><a href=#registermessagewillformathookhttpsdevelopersmattermostcomextendpluginswebappreferenceregistermessagewillformathook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillFormatHook>registerMessageWillFormatHook</a></a></li><li><a href=#registerfilepreviewcomponenthttpsdevelopersmattermostcomextendpluginswebappreferenceregisterfilepreviewcomponent><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerFilePreviewComponent>registerFilePreviewComponent</a></a></li><li><a href=#registertranslationshttpsdevelopersmattermostcomextendpluginswebappreferenceregistertranslations><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerTranslations>registerTranslations</a></a></li><li><a href=#registeradminconsolepluginhttpsdevelopersmattermostcomextendpluginswebappreferenceregisteradminconsoleplugin><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsolePlugin>registerAdminConsolePlugin</a></a></li><li><a href=#unregisteradminconsolepluginhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisteradminconsoleplugin><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterAdminConsolePlugin>unregisterAdminConsolePlugin</a></a></li><li><a href=#registeradminconsolecustomsettinghttpsdevelopersmattermostcomextendpluginswebappreferenceregisteradminconsolecustomsetting><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsoleCustomSetting>registerAdminConsoleCustomSetting</a></a></li><li><a href=#registerrighthandsidebarcomponenthttpsdevelopersmattermostcomextendpluginswebappreferenceregisterrighthandsidebarcomponent><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerRightHandSidebarComponent>registerRightHandSidebarComponent</a></a></li><li><a href=#registerneedsteamroutehttpsdevelopersmattermostcomextendpluginswebappreferenceregisterneedsteamroute><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerNeedsTeamRoute>registerNeedsTeamRoute</a></a></li><li><a href=#registercustomroutehttpsdevelopersmattermostcomextendpluginswebappreferenceregistercustomroute><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerCustomRoute>registerCustomRoute</a></a></li></ul></li><li><a href=#その他>その他</a><ul><li><a href=#themehttpsdevelopersmattermostcomextendpluginswebappreferencetheme><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#theme>Theme</a></a></li><li><a href=#exported-libraries-and-functionshttpsdevelopersmattermostcomextendpluginswebappreferenceexported-libraries-and-functions><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions>Exported Libraries and Functions</a></a></li><li><a href=#redux-actionhttpsdevelopersmattermostcomextendpluginswebappactions><a href=https://developers.mattermost.com/extend/plugins/webapp/actions/>Redux Action</a>)</a></li></ul></li><li><a href=#さいごに>さいごに</a></li></ul></nav><h2 id=本記事について>本記事について</h2><p><a href=https://qiita.com/advent-calendar/2020/mattermost-integrations>Mattermostの統合機能アドベントカレンダー</a>の第21日目の記事です。</p><p>昨日に引き続き、Mattermost上の様々な操作に対応した処理を追加できるMattermost Pluginの<strong>Webapp</strong>サイドの機能を紹介していきます。。</p><p>Mattermost Pluginについての公式ドキュメントは下記になります。
<a href=https://developers.mattermost.com/extend/plugins/overview/>https://developers.mattermost.com/extend/plugins/overview/</a></p><p>サンプルコードは下記リポジトリにコミットしています。
<a href=https://github.com/kaakaa/mattermost-plugin-api-sample>https://github.com/kaakaa/mattermost-plugin-api-sample</a></p><h2 id=webapp-plugin-api>Webapp Plugin API</h2><h3 id=registerwebsocketeventhandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterwebsocketeventhandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler>registerWebSocketEventHandler</a></h3><p><code>registerWebSocketEventHandler</code>は、Mattermost Serverから送信されるWebSocketイベントを処理するHandlerを登録します。</p><p><code>registerWebSocketEventHandler</code>は2つの引数を取ります。</p><ul><li><code>event</code>: 処理するWebSocketイベントの種別</li><li><code>handler</code>: WebSocketイベントのデータを引数に取る関数。引数のデータはイベントによって異なります。</li></ul><p>Serverプラグインの<a href=https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent>PublishWebSocketEvent</a>と組み合わせて使用すると強力ですが、その辺りの例については22日目以降の記事で紹介します。</p><p>ここでは、MattermostデフォルトのWebSocketイベントである投稿が作成された際に送信される<code>posted</code>イベントを受信した際に、投稿内容に<code>open modal</code>という文言が入っていた場合にモーダルを開く例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/websocket-event-handler.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>openRootModal</span>, <span style=color:#a6e22e>createPluginPost</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./actions&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// &#39;open modal&#39;を含む投稿を受信するとモーダルを開く
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerWebSocketEventHandler</span>(
            <span style=color:#e6db74>&#39;posted&#39;</span>,
            (<span style=color:#a6e22e>event</span>) =&gt; {
                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>post</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>post</span>);
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>post</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;open modal&#39;</span>)) {
                    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>dispatch</span>(<span style=color:#a6e22e>openRootModal</span>());
                }
            }
        );
    }
}
</code></pre></div><h3 id=unregisterwebsocketeventhandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisterwebsocketeventhandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterWebSocketEventHandler>unregisterWebSocketEventHandler</a></h3><p><code>unregisterWebSocketEventHandler</code>は、<code>registerWebSocketEventHandler</code>によってWebSocketイベントに対して設定されたHandlerを登録から除外します。</p><p>例は省略します。</p><h3 id=registerreconnecthandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterreconnecthandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerReconnectHandler>registerReconnectHandler</a></h3><p><code>registerReconnectHandler</code>は、一度インターネット接続が失われた後に再びMattermostへ接続した際に実行されるHandlerです。</p><p><code>registerReconnectHandler</code>は引数のない関数を引数に取ります。</p><ul><li><code>handler</code>: Mattermostへ再接続した際に実行される関数</li></ul><p>例は省略します。</p><h3 id=unregisterreconnecthandlerhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisterreconnecthandler><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterReconnectHandler>unregisterReconnectHandler</a></h3><p><code>unregisterReconnectHandler</code>は、<code>registerReconnectHandler</code>で登録したHandlerを登録から除外します。引数は取りません。</p><p>こちらも例は省略します。</p><h3 id=registermessagewillbepostedhookhttpsdevelopersmattermostcomextendpluginswebappreferenceregistermessagewillbepostedhook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillBePostedHook>registerMessageWillBePostedHook</a></h3><p><code>registerMessageWillBePostedHook</code>は、ユーザーが投稿を送信した際、その投稿がサーバーに送信される前に実行される処理を登録します。</p><p><code>registerMessageWillBePostedHook</code>は、引数を1つ取ります。</p><ul><li><code>hook</code>: ユーザーによって投稿処理が実行された際、その投稿がサーバーに送信される直前に実行される処理</li></ul><p><code>hooks</code>は、引数を一つ取ります。</p><ul><li><code>post</code>: 投稿の情報</li></ul><p><code>hook</code>の返り値として、投稿情報を持つ<code>error</code>フィールドを含む値を返却した場合、投稿はrejectされます。投稿情報を持つ<code>post</code>フィールドのを含むオブジェクトを返却した場合は、<code>post</code>フィールドの値で投稿が作成されます。</p><p><code>忙しい</code>という文言を含む投稿を作成するとrejectされ、<code>帰りたい</code>という文言を含む投稿を作成すると<code>仕事したい</code>に変換される例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/message-will-be-posted-hook.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// 投稿がサーバーに送信される前にrejectしたり内容を変換したりする
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerMessageWillBePostedHook</span>(
            (<span style=color:#a6e22e>post</span>) =&gt; {
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;忙しい&#39;</span>)) {
                    <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;忙しくはないはずです&#39;</span>}};
                }
                <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/帰りたい/gi</span>, <span style=color:#e6db74>&#39;仕事したい&#39;</span>);
                <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>post</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>post</span>};
            }
        );
    }
}
</code></pre></div><h3 id=registerslashcommandwillbepostedhookhttpsdevelopersmattermostcomextendpluginswebappreferenceregisterslashcommandwillbepostedhook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerSlashCommandWillBePostedHook>registerSlashCommandWillBePostedHook</a></h3><p><code>registerSlashCommandWillBePostedHook</code>は、ユーザーがSlash Commandを実行した際、その投稿がサーバーに送信される前に実行される処理を登録します。</p><p><code>registerSlashCommandWillBePostedHook</code>は、引数を1つ取ります。</p><ul><li><code>hook</code>: Slash Commandが実行された際に、その内容がサーバーに送信される直前に実行される処理</li></ul><p><code>hook</code>は、引数を2つ取ります。</p><ul><li><code>message</code>: 投稿されたメッセージ</li><li><code>args</code>: Slash Command実行情報(<code>channel_id</code>, <code>team_id</code>, <code>root_id</code>, <code>parent_id</code>)</li></ul><p><code>/away</code>をreject、<code>/help</code>を<code>/shrug</code>に書き換え、<code>/leave</code>をエラーメッセージなしでrejectするような処理を実行する例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/slash-command-will-be-posted-hook.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// Slash Commandがサーバーに送信される前に実行される処理を追加する
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerSlashCommandWillBePostedHook</span>(
            (<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>args</span>) =&gt; {
                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>message</span>);
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/away&#39;</span>)) {
                    <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rejected&#39;</span>}};
                }
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/help&#39;</span>)) {
                    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;help&#39;</span>);
                    <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/shrug converted from help command&#39;</span>, <span style=color:#a6e22e>args</span>};
                }
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/leave&#39;</span>)) {
                    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;leave&#39;</span>);
                    <span style=color:#66d9ef>return</span> {};
                }
            }
        );
    }
}
</code></pre></div><h3 id=registermessagewillformathookhttpsdevelopersmattermostcomextendpluginswebappreferenceregistermessagewillformathook><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillFormatHook>registerMessageWillFormatHook</a></h3><p><code>registerMessageWillFormatHook</code>は、投稿したメッセージがMarkdownテキストとして変換される直前に実行される処理を登録します。</p><p><code>registerMessageWillFormatHook</code>は、引数を1つ取ります。</p><ul><li><code>hook</code>: 投稿がMarkdownテキストとして変換される直前に実行される処理</li></ul><p><code>hook</code>は、引数を2つ取ります。</p><ul><li><code>post</code>: 変換されていない投稿情報</li><li><code>message</code>: 投稿されたメッセージ（プラグインによって変換されている可能性あり）</li></ul><p><code>hook</code>の返却値として返された文字列が投稿として表示されます。</p><p><code>registerMessageWillBePostedHook</code>は、投稿がサーバーに送信される前に投稿内容を編集するものでしたが、この<code>registerMessageWillFormatHook</code>は、投稿がサーバーに送信・保存された後にレンダリングされる際にメッセージを編集するものだと思われます。</p><p>良い利用方法が思いつかないので例は省略します。</p><h3 id=registerfilepreviewcomponenthttpsdevelopersmattermostcomextendpluginswebappreferenceregisterfilepreviewcomponent><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerFilePreviewComponent>registerFilePreviewComponent</a></h3><p><code>registerFilePreviewComponent</code>は、ファイルプレビュー用の独自のComponentを登録します。</p><p><code>registerFilePreviewComponent</code>は、2つの関数を引数に取ります。</p><ul><li><code>override</code>: 独自のファイルプレビューComponentを使用するかどうかを決定するための関数。以下の2つを引数に取ります。</li><li><code>component</code>: ファイルプレビュー用のComponent</li></ul><p><code>override</code>は、引数を2つ取ります。</p><ul><li><code>fileInfo</code>: ファイルの情報</li><li><code>post</code>: 投稿の情報</li></ul><p><code>debug</code>で始まるメッセージを持つ投稿の添付ファイルをプレビューする際に、独自のコンポーネントを使用する例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/file-preview-component.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>CustomFilePreview</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./components/custom_file_preview&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// `debug`で始まるメッセージを持つ投稿の添付ファイルを独自コンポーネントでプレビューする
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerFilePreviewComponent</span>(
            (<span style=color:#a6e22e>fileInfo</span>, <span style=color:#a6e22e>post</span>) =&gt; { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;debug&#39;</span>); },
            <span style=color:#a6e22e>CustomFilePreview</span>
        );
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:components/custom_file_preview.jsx data-lang=js:components/custom_file_preview.jsx><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PropTypes</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;prop-types&#39;</span>;

<span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>formatText</span>, <span style=color:#a6e22e>messageHtmlToComponent</span>} <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>PostUtils</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CustomFilePreviewComponent</span> <span style=color:#f92672>=</span> ({<span style=color:#a6e22e>fileInfo</span>, <span style=color:#a6e22e>post</span>}) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>formattedText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>messageHtmlToComponent</span>(<span style=color:#a6e22e>formatText</span>(<span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>message</span>));

    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>backgroundColor</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#ffcccc&#39;</span>}}&gt;
            {<span style=color:#a6e22e>formattedText</span>}
            &lt;<span style=color:#f92672>pre</span>&gt;
                {<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>fileInfo</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>4</span>)}
            &lt;/<span style=color:#f92672>pre</span>&gt;
        &lt;/<span style=color:#f92672>div</span>&gt;
    )
}

<span style=color:#a6e22e>CustomFilePreviewComponent</span>.<span style=color:#a6e22e>propTypes</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>fileInfo</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>isRequired</span>,
    <span style=color:#a6e22e>post</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>isRequired</span>,
};

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>CustomFilePreviewComponent</span>;
</code></pre></div><h3 id=registertranslationshttpsdevelopersmattermostcomextendpluginswebappreferenceregistertranslations><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerTranslations>registerTranslations</a></h3><p><code>registerTranslations</code>は、プラグイン内で使用しているメッセージの翻訳データを登録します。</p><p><code>registerTranslations</code>は、<code>locale</code>を引数にとり、その<code>locale</code>に対する翻訳データを返す関数を引数に取ります。</p><p>RootModal内のメッセージを日本語に翻訳する例を作ってみましたが、どうやら翻訳が正常に動作していない模様？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>ja</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;i18n/&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// 翻訳メッセージを登録する
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerTranslations</span>((<span style=color:#a6e22e>locale</span>) =&gt; {
            <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>locale</span>) {
            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;en&#39;</span><span style=color:#f92672>:</span>
                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>en</span>;
            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;ja&#39;</span><span style=color:#f92672>:</span>
                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ja</span>;
            }
            <span style=color:#66d9ef>return</span> {};
        });
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json:i18n/ja.json data-lang=json:i18n/ja.json>{
    <span style=color:#f92672>&#34;rootModal.message&#34;</span>: <span style=color:#e6db74>&#34;ルートモーダル&#34;</span>
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:components/root/root.jsx data-lang=js:components/root/root.jsx>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>;

<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>FormattedMessage</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react-intl&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Root</span> <span style=color:#f92672>=</span> ({<span style=color:#a6e22e>visible</span>, <span style=color:#a6e22e>close</span>}) =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>visible</span>) {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
    }

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>style</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getStyle</span>();

    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>div</span>
            <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>backdrop</span>}
            <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>close</span>}
        &gt;
            &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>modal</span>}&gt;
                &lt;<span style=color:#f92672>FormattedMessage</span>
                    <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rootModal.message&#39;</span>
                    <span style=color:#a6e22e>defaultMessage</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Root Modal2&#39;</span>
                /&gt;
            &lt;/<span style=color:#f92672>div</span>&gt;
        &lt;/<span style=color:#f92672>div</span>&gt;
    );
};

<span style=color:#a6e22e>Root</span>.<span style=color:#a6e22e>propTypes</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>visible</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>bool</span>.<span style=color:#a6e22e>isRequired</span>,
    <span style=color:#a6e22e>close</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>func</span>.<span style=color:#a6e22e>isRequired</span>,
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getStyle</span> <span style=color:#f92672>=</span> () =&gt; ({
    <span style=color:#a6e22e>backdrop</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>position</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;absolute&#39;</span>,
        <span style=color:#a6e22e>display</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;flex&#39;</span>,
        <span style=color:#a6e22e>top</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
        <span style=color:#a6e22e>left</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
        <span style=color:#a6e22e>right</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
        <span style=color:#a6e22e>bottom</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
        <span style=color:#a6e22e>backgroundColor</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rgba(0, 0, 0, 0.50)&#39;</span>,
        <span style=color:#a6e22e>zIndex</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2000</span>,
        <span style=color:#a6e22e>alignItems</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;center&#39;</span>,
        <span style=color:#a6e22e>justifyContent</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;center&#39;</span>,
    },
    <span style=color:#a6e22e>modal</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>height</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;300px&#39;</span>,
        <span style=color:#a6e22e>width</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;500px&#39;</span>,
        <span style=color:#a6e22e>padding</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1em&#39;</span>,
        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;black&#39;</span>,
        <span style=color:#a6e22e>backgroundColor</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;white&#39;</span>,
    },
});

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Root</span>;
</code></pre></div><h3 id=registeradminconsolepluginhttpsdevelopersmattermostcomextendpluginswebappreferenceregisteradminconsoleplugin><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsolePlugin>registerAdminConsolePlugin</a></h3><p><code>registerAdminConsolePlugin</code>は、AdminConsole(システムコンソール?)の内容を上書きするための関数を登録します。</p><p>Mattermost内部での利用が主目的であり、ユーザープラグインによる使用は推奨されていないようなので例は省略します。（使い方がよく分からない）</p><h3 id=unregisteradminconsolepluginhttpsdevelopersmattermostcomextendpluginswebappreferenceunregisteradminconsoleplugin><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterAdminConsolePlugin>unregisterAdminConsolePlugin</a></h3><p><code>unregisterAdminConsolePlugin</code>は、<code>registerAdminConsolePlugin</code>で登録した　AdminConsole上書き用関数を登録から除外します。
<code>registerAdminConsolePlugin</code>がMattermost内部での利用が主目的のため、こちらも説明、例は省略します。</p><h3 id=registeradminconsolecustomsettinghttpsdevelopersmattermostcomextendpluginswebappreferenceregisteradminconsolecustomsetting><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsoleCustomSetting>registerAdminConsoleCustomSetting</a></h3><p><code>registerAdminConsoleCustomSetting</code>は、プラグイン用の設定画面に独自のコンポーネントを追加します。
このプラグインAPIについては、公式ドキュメントの<a href=https://developers.mattermost.com/extend/plugins/best-practices/#how-can-a-plugin-define-its-own-setting-type>Best Practices</a>のページに詳細にまとめられています。</p><p>Mattermost Pluginでは、マニフェストファイルの<code>settings_schema</code>という項目を指定することで、プラグイン専用の設定項目を作成することができます。</p><p><a href=https://developers.mattermost.com/extend/plugins/manifest-reference/>https://developers.mattermost.com/extend/plugins/manifest-reference/</a></p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/admin-console-custom-settings-default.png alt></p><p>デフォルトでは、下記の<code>type</code>を持つ設定項目を追加することができます。</p><ul><li>&ldquo;bool&rdquo;: ラジオボタン (2値)</li><li>&ldquo;dropdown&rdquo;: ドロップダウンメニュー</li><li>&ldquo;generated&rdquo;: 自動生成テキスト</li><li>&ldquo;radio&rdquo;: ラジオボタン (任意)</li><li>&ldquo;text&rdquo;: インプットボックス</li><li>&ldquo;longtext&rdquo;: 複数行テキスト</li><li>&ldquo;number&rdquo;: 数値入力欄</li><li>&ldquo;username&rdquo;:ユーザー名入力欄</li></ul><p>デフォルトの<code>type</code>以外の設定項目を指定したい場合に<code>registerAdminConsoleCustomSetting</code>を使用します。</p><p><code>registerAdminConsoleCustomSetting</code>は、3つの引数を取ります。</p><ul><li><code>key</code>: 上書きする設定項目の<code>key</code>。<code>key</code>は、マニフェストファイルに設定項目ごとに任意で指定する値です。</li><li><code>component</code>: 設定画面に表示されるComponent。</li><li><code>options</code>: 設定項目の表示方法についてのオプション<ul><li><code>showTitle</code>: <code>true</code>を指定した場合、マニフェストファイルの<code>display_name</code>が設定項目の左側に表示されます</li></ul></li></ul><p>パスワードなどを入力する際に、入力項目をUI上に表示しないような設定項目を追加する例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/admin-console-custom-settings.png alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json:plugin.json data-lang=json:plugin.json>{
    <span style=color:#960050;background-color:#1e0010>...</span>
    <span style=color:#f92672>&#34;settings_schema&#34;</span>: {
        <span style=color:#f92672>&#34;settings&#34;</span>: [
            {
                <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;SampleSetting&#34;</span>,
                <span style=color:#f92672>&#34;display_name&#34;</span>: <span style=color:#e6db74>&#34;Sample Setings Value&#34;</span>,
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
                <span style=color:#f92672>&#34;help_text&#34;</span>: <span style=color:#e6db74>&#34;Sample&#34;</span>,
                <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;sample&#34;</span>
            }
        ]
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>CustomSettings</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./components/custom_settings&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// 独自の設定画面項目を追加する
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerAdminConsoleCustomSetting</span>(
            <span style=color:#e6db74>&#39;SampleSetting&#39;</span>,
            <span style=color:#a6e22e>CustomSettings</span>,
            {<span style=color:#a6e22e>showTitle</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>}
        );
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:components/custom_settings.jsx data-lang=js:components/custom_settings.jsx><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PropTypes</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;prop-types&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CustomSettingsComponent</span> <span style=color:#f92672>=</span> ({<span style=color:#a6e22e>helpText</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>onChange</span>, <span style=color:#a6e22e>value</span>}) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handleChange</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span>) =&gt; {
        <span style=color:#a6e22e>onChange</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>value</span>);
    }
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>backgroundColor</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#ffcccc&#39;</span>}}&gt;
            &lt;<span style=color:#f92672>input</span>
              <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;password&#39;</span>}
              <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>value</span>}
              <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleChange</span>}
            /&gt;
            &lt;<span style=color:#f92672>pre</span>&gt;
                {<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>helpText</span>.<span style=color:#a6e22e>props</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>4</span>)}
            &lt;/<span style=color:#f92672>pre</span>&gt;
        &lt;/<span style=color:#f92672>div</span>&gt;
    )
}

<span style=color:#a6e22e>CustomSettingsComponent</span>.<span style=color:#a6e22e>propTypes</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>helpText</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>shape</span> ({
        <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>,
    }),
    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>string</span>,
    <span style=color:#a6e22e>onChange</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>func</span>,
    <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>any</span>,
};

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>CustomSettingsComponent</span>;
</code></pre></div><h3 id=registerrighthandsidebarcomponenthttpsdevelopersmattermostcomextendpluginswebappreferenceregisterrighthandsidebarcomponent><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerRightHandSidebarComponent>registerRightHandSidebarComponent</a></h3><p><code>registerRightHandSidebarComponent</code>は、Mattermostの右サイドバーに表示する独自のComponentを登録します。</p><p><code>registerRightHandSidebarComponent</code>は、2つの引数を取ります。</p><ul><li><code>component</code>: 右サイドバーに表示されるComponent</li><li><code>title</code>: 右サイドバーのタイトル部分に表示されるテキスト</li></ul><p>また、<code>registerRightHandSidebarComponent</code>は4つの引数を返却します。</p><ul><li><code>id</code>: 登録されたComponentのID</li><li><code>showRHSPlugin</code>: 登録したComponentを表示するためのアクション</li><li><code>hideRHSPlugin</code>: 登録したComponentを非表示にするためのアクション</li><li><code>toggleRHSPlugin</code>: 登録したComponentの表示/非表示を切り替えるアクション</li></ul><p>登録したComponentは、他のプラグインAPIから<code>shorRHSPlugin</code>、<code>hideRHSPlugin</code>、<code>toggleRHSPlugin</code>のアクションを実行することで表示されるようになります。<code>RHS</code>は<code>RightHandSideber</code>の略です。</p><p>右サイドバーに独自のComponentを表示するためのメニューをメインメニューに追加する例を以下に示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/right-hand-sidebar.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>CustomRightHandSideber</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./components/custom_rhs&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// 右サイドバーに表示される独自Componentを登録する
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>toggleRHSPlugin</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerRightHandSidebarComponent</span>(<span style=color:#a6e22e>CustomRightHandSideber</span>, <span style=color:#e6db74>&#34;Sample RHS&#34;</span>)
        <span style=color:#75715e>// 右サイドバーを表示するためのメインメニューを追加する
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerMainMenuAction</span>(
            <span style=color:#e6db74>&#39;Open RHS&#39;</span>,
            () =&gt; <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>dispatch</span>(<span style=color:#a6e22e>toggleRHSPlugin</span>),
            () =&gt; (<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>i</span><span style=color:#f92672>/&gt;</span>)
        );
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:components/custom_rhs.jsx data-lang=js:components/custom_rhs.jsx><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PropTypes</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;prop-types&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ComponentRightHandSidebar</span> <span style=color:#f92672>=</span> ({<span style=color:#a6e22e>theme</span>}) =&gt; {
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>backgroundColor</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#ffcccc&#39;</span>}}&gt;
            &lt;<span style=color:#f92672>pre</span>&gt;
                {<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>theme</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>4</span>)}
            &lt;/<span style=color:#f92672>pre</span>&gt;
        &lt;/<span style=color:#f92672>div</span>&gt;
    )
}

<span style=color:#a6e22e>ComponentRightHandSidebar</span>.<span style=color:#a6e22e>propTypes</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>PluggableId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>string</span>.<span style=color:#a6e22e>isRequired</span>,
    <span style=color:#a6e22e>theme</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>isRequired</span>,
};

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>ComponentRightHandSidebar</span>;
</code></pre></div><h3 id=registerneedsteamroutehttpsdevelopersmattermostcomextendpluginswebappreferenceregisterneedsteamroute><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerNeedsTeamRoute>registerNeedsTeamRoute</a></h3><p><code>registerNeedsTeamRoute</code>は、チームごとにプラグイン専用のRouteを追加します。プラグイン専用のエラー画面を作成したい場合などに使用するものだと思います。</p><p><code>registerNeedsTeamRoute</code>は、2つの引数を取ります。</p><ul><li><code>route</code>: ルート文字列</li><li><code>comopnent</code>: <code>route</code>にアクセスされた際に呼び出されるComponent</li></ul><p><code>http://localhost:8065</code>でMattermostが起動していて、<code>test</code>というチーム名のチームがあり、<code>sample.plugin</code>というプラグインIDを持つプラグインがインストールされており、その中で<code>registerNeedsTeamRoute</code>の引数として<code>route="/subpath"</code>が指定されていた場合、<code>http://localhost:8065/test/sample.plugin/subpath</code>にアクセスすると、<code>component</code>に指定したコンポーネントが呼び出されます。</p><p>以下に例を示します。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/needs-team-route.gif alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:index.js data-lang=js:index.js>...
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>CustomTeamRoute</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./components/custom_team_route&#39;</span>;
...
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Plugin</span> {
    <span style=color:#75715e>// eslint-disable-next-line no-unused-vars
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>initialize</span>(<span style=color:#a6e22e>registry</span>, <span style=color:#a6e22e>store</span>) {
		...
        <span style=color:#75715e>// 独自のRouteを追加する
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>registerNeedsTeamRoute</span>(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#a6e22e>CustomTeamRoute</span>)
    }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:components/custom_team_route.jsx data-lang=js:components/custom_team_route.jsx><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react&#39;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PropTypes</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;prop-types&#39;</span>;

<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>Switch</span>, <span style=color:#a6e22e>Route</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react-router-dom&#39;</span>;
<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>getCurrentTeam</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;mattermost-redux/selectors/entities/teams&#39;</span>;
<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>useSelector</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;react-redux&#39;</span>;

<span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>id</span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;src/manifest&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CustomTeamRouteComponent</span> <span style=color:#f92672>=</span> () =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentTeam</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useSelector</span>(<span style=color:#a6e22e>getCurrentTeam</span>);
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>Switch</span>&gt;
            &lt;<span style=color:#f92672>Route</span> <span style=color:#a6e22e>path</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>currentTeam</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/error`</span>}&gt;
                &lt;<span style=color:#f92672>h3</span>&gt;{<span style=color:#e6db74>&#39;This is error page!&#39;</span>}&lt;/<span style=color:#f92672>h3</span>&gt;
                &lt;<span style=color:#f92672>p</span>&gt;
                    &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>currentTeam</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}&gt;<span style=color:#a6e22e>Back</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>Top</span>&lt;/<span style=color:#f92672>a</span>&gt;
                &lt;/<span style=color:#f92672>p</span>&gt;
            &lt;/<span style=color:#f92672>Route</span>&gt;
            &lt;<span style=color:#f92672>Route</span>&gt;
                &lt;<span style=color:#f92672>h3</span>&gt;{<span style=color:#e6db74>&#39;404 Not Found&#39;</span>}&lt;/<span style=color:#f92672>h3</span>&gt;
                &lt;<span style=color:#f92672>p</span>&gt;
                    &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>currentTeam</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}&gt;<span style=color:#a6e22e>Back</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>Top</span>&lt;/<span style=color:#f92672>a</span>&gt;
                &lt;/<span style=color:#f92672>p</span>&gt;
            &lt;/<span style=color:#f92672>Route</span>&gt;
        &lt;/<span style=color:#f92672>Switch</span>&gt;
    )
}

<span style=color:#a6e22e>CustomTeamRouteComponent</span>.<span style=color:#a6e22e>propTypes</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>pluggableId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>isRequired</span>,
    <span style=color:#a6e22e>theme</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropTypes</span>.<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>isRequired</span>,
};

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>CustomTeamRouteComponent</span>;
</code></pre></div><h3 id=registercustomroutehttpsdevelopersmattermostcomextendpluginswebappreferenceregistercustomroute><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#registerCustomRoute>registerCustomRoute</a></h3><p><code>registerCustomRoute</code>は、プラグイン専用のRouteを追加します。</p><p><code>registerNeedsTeamRoute</code>は、<code>/${team_name}/${plugin_id}/${route}</code>のようにチームごとにRouteを追加するAPIでしたが、<code>registerCustomRoute</code>は<code>/plug/${plugin_id}/${route}</code>のように、Mattermost全体としてプラグインごとに一つのRouteを追加するAPIです。</p><p>使い方は<code>registerNeedsTeamRoute</code>とほぼ同じのため、例は省略します。</p><h2 id=その他>その他</h2><p>Mattermost Plugin Webapp開発中に使えるPlugin開発用の便利機能がいくつかあります。その概要だけ紹介します。</p><h3 id=themehttpsdevelopersmattermostcomextendpluginswebappreferencetheme><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#theme>Theme</a></h3><p>Mattermost Plugin APIの中でも何度か出てきましたが、Webapp PluginではMattermostのテーマカラーを参照することができます。Mattermostではユーザーごとにテーマカラーを変更することができるため、Webapp PluginでUIの色を指定する場合は、ユーザーごとに見え方が異なることを考慮に入れる必要があります。</p><p>参考: <a href=https://qiita.com/kaakaa_hoe/items/45c8857589ccd822ab1a>Mattermostのテーマ集 - Qiita</a></p><p>Mattermostで扱われるテーマカラー一覧は以下で紹介されています。</p><p><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#theme>https://developers.mattermost.com/extend/plugins/webapp/reference/#theme</a></p><h3 id=exported-libraries-and-functionshttpsdevelopersmattermostcomextendpluginswebappreferenceexported-libraries-and-functions><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions>Exported Libraries and Functions</a></h3><p>Mattermost Webapp PluginはReact.jsを使用して開発しますが、React開発によく使われるいくつかのライブラリはMattermost本体から<code>window</code>オブジェクトを介して取得できるようになっています。
取得できるライブラリは以下で紹介されています。</p><p><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions>https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions</a></p><p>また、<code>window</code>オブジェクトから参照できるライブラリとして<code>window.PostUtils</code>というのがありますが、これはMattermostフォーマットのテキストを扱うための便利関数を持つオブジェクトです。</p><p>以下のようにすることで、@メンションなどを含むMarkdownテキスト(<code>text</code>)をフォーマットして扱うことができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>formatText</span>, <span style=color:#a6e22e>messageHtmlToComponent</span>} <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>PostUtils</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;...&#39;</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>formattedText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>messageHtmlToComponent</span>(<span style=color:#a6e22e>formatText</span>(<span style=color:#a6e22e>text</span>));
</code></pre></div><p><a href=https://developers.mattermost.com/extend/plugins/webapp/reference/#post-utils>https://developers.mattermost.com/extend/plugins/webapp/reference/#post-utils</a></p><h3 id=redux-actionhttpsdevelopersmattermostcomextendpluginswebappactions><a href=https://developers.mattermost.com/extend/plugins/webapp/actions/>Redux Action</a>)</h3><p>Webapp上で投稿やユーザー情報の取得などのMattermostに対する何かしらの処理を実行する場合、<a href=https://github.com/mattermost/mattermost-redux>mattermost-redux</a>というReduxライブラリがあります。これはMattermost本体のWebappでも利用されている公式のJavascript APIのような位置付けのものです。</p><p>mattermost-reduxはもちろんMattermost Plugin開発でも使用することができ、下記のページで使い方について紹介されています。</p><p><a href=https://developers.mattermost.com/extend/plugins/webapp/actions/>https://developers.mattermost.com/extend/plugins/webapp/actions/</a></p><h2 id=さいごに>さいごに</h2><p>本日は、Mattermost Pluginの<strong>Webapp</strong>サイドの実装について紹介しました。
明日からは、Mattermost上で投票機能を使うことができるMatterPollプラグインの実装について紹介していきます。</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/integration/>integration</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/plugin/>plugin</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/webapp/>webapp</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://github.com/kaakaa name=GitHub><em class="fab fa-github-alt fa-lg"></em></a><a href=https://twitter.com/kaakaa_hoe_prog name=Twitter><em class="fab fa-twitter fa-lg"></em></a><a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita><img src=https://blog.kaakaa.dev/images/qiita.png width=20 height=20 alt=Qiita></a></div><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>