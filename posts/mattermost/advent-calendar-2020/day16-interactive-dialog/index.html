<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>[Mattermost Integrations] Interactive Dialog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="[Mattermost Integrations] Interactive Dialog"><meta name=twitter:description content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第16日目の記事です。 本記事では、Mat"><meta property="og:title" content="[Mattermost Integrations] Interactive Dialog"><meta property="og:description" content="Mattermost記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ 本記事について Mattermostの統合機能アドベントカレンダーの第16日目の記事です。 本記事では、Mat"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaakaa.dev/posts/mattermost/advent-calendar-2020/day16-interactive-dialog/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-16T00:00:00+09:00"><meta property="article:modified_time" content="2020-12-16T00:00:00+09:00"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><a href=https://blog.kaakaa.dev/ class=nav-logo><img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/ id=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>[Mattermost Integrations] Interactive Dialog</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>Mattermost記事まとめ: <a href=https://blog.kaakaa.dev/tags/mattermost/>https://blog.kaakaa.dev/tags/mattermost/</a></p><nav id=TableOfContents><ul><li><a href=#本記事について>本記事について</a></li><li><a href=#interactive-dialogの概要>Interactive Dialogの概要</a><ul><li><a href=#trigger-idの取得>Trigger IDの取得</a></li><li><a href=#interactive-dialogの起動>Interactive Dialogの起動</a></li><li><a href=#interactive-dialogからのリクエスト受信>Interactive Dialogからのリクエスト受信</a></li></ul></li><li><a href=#さいごに>さいごに</a></li></ul></nav><h2 id=本記事について>本記事について</h2><p><a href=https://qiita.com/advent-calendar/2020/mattermost-integrations>Mattermostの統合機能アドベントカレンダー</a>の第16日目の記事です。</p><p>本記事では、Mattermostでユーザーの入力を受け付けるダイアログを表示するInteractive Dialogの機能について紹介します。</p><h2 id=interactive-dialogの概要>Interactive Dialogの概要</h2><p>Interactive Dialogは、Slash CommandやInteractive Messageなどのアクションを起点に、Mattermost上にユーザー入力を受け付けるダイアログ(モーダルウィンドウ)を表示する機能です。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day16/official-example.png alt="official example">
(画像は<a href=https://docs.mattermost.com/developer/interactive-dialogs.html>公式ドキュメント</a>から)</p><p>Interactive Dialogに関する公式ドキュメントは下記になります。</p><ul><li><a href=https://docs.mattermost.com/developer/interactive-dialogs.html>https://docs.mattermost.com/developer/interactive-dialogs.html</a></li></ul><p>Interactie Dialogは、何度かMattermostとインタラクションをしながら動作するもののため、動作が複雑になります。今までのように<code>curl</code>だけで動作させることは難しいため、Goのコードで書いたものを断片的に紹介していきます。</p><p>今回は、Interactive Dialogの入力内容からMessage Attachmentsのメッセージを作成するような例を考えてみます。</p><h3 id=trigger-idの取得>Trigger IDの取得</h3><p>Interactive Dialogを起動するには、まず、Mattermost内部で生成されるTrigger IDというものが必要です。Trigger IDはSlash CommandやInteractive Messageのアクションを実行した時に、Mattermostから送信されるリクエストに含まれています。Slash Command実行時のリクエストからTrigger IDを取得する場合、Slash Command実行時に送信されるリクエストを処理するサーバーで、以下のようにTrigger IDを取得することができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/command&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ParseForm</span>()

		<span style=color:#75715e>// (1) Slash Command実行時に送信されるリクエストから &#34;Trigger ID&#34; を取得
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>triggerId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Form</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;trigger_id&#34;</span>)

		<span style=color:#f92672>...</span>
</code></pre></div><p>Interactive Message Buttonなどのアクションから取得する際は、<a href=https://github.com/mattermost/mattermost-server/blob/master/model/integration_action.go#L173><code>PostActionIntegrationRequest.TriggerId</code></a>からTrigger IDを取得できます。</p><h3 id=interactive-dialogの起動>Interactive Dialogの起動</h3><p>先ほど取得したTrigger IDを使って、MattermostへInteractive Dialog起動のリクエストを投げます。
Trigger IDを取得するコードに続けて、<a href=https://api.mattermost.com/#tag/integration_actions/paths/~1actions~1dialogs~1open/post><code>/api/v4/actions/dialogs/open</code></a>に<a href=https://github.com/mattermost/mattermost-server/blob/master/model/integration_action.go#L224><code>OpenDialogRequest</code></a>で定義されるリクエストを送信することでInteractive Dialogを起動することができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/command&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ParseForm</span>()

		<span style=color:#75715e>// (1) Slash Command実行時に送信されるリクエストから &#34;Trigger ID&#34; を取得
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>triggerId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Form</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;trigger_id&#34;</span>)

		<span style=color:#75715e>// (2) Interactive Dialogを起動するためのリクエストを構築
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>request</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>OpenDialogRequest</span>{
			<span style=color:#a6e22e>TriggerId</span>: <span style=color:#a6e22e>triggerId</span>,
			<span style=color:#a6e22e>URL</span>:       <span style=color:#e6db74>&#34;http://localhost:8080/actions/dialog&#34;</span>,
			<span style=color:#a6e22e>Dialog</span>: <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Dialog</span>{
				<span style=color:#a6e22e>Title</span>: <span style=color:#e6db74>&#34;Sample Interactive Dialog&#34;</span>,
				<span style=color:#a6e22e>Elements</span>: []<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>DialogElement</span>{{
					<span style=color:#a6e22e>DisplayName</span>: <span style=color:#e6db74>&#34;Title&#34;</span>,
					<span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;title&#34;</span>,
					<span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;text&#34;</span>,
				}, {
					<span style=color:#a6e22e>DisplayName</span>: <span style=color:#e6db74>&#34;Message&#34;</span>,
					<span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;message&#34;</span>,
					<span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;textarea&#34;</span>,
				}},
			},
		}

		<span style=color:#75715e>// (3) Interactive Dialogを開く
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>request</span>)
		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;http://localhost:8065/api/v4/actions/dialogs/open&#34;</span>, <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>b</span>))
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)

		<span style=color:#f92672>...</span>
</code></pre></div><p><code>(2)</code>で構築している<code>OpenDialogRequest</code>にどのようなダイアログを表示するかという情報も指定するのですが、詳しくは後述します。
<code>(3)</code>で<a href=https://api.mattermost.com/#tag/integration_actions/paths/~1actions~1dialogs~1open/post><code>/actions/dialogs/open</code></a>にリクエストを送信していますが、ここではAccessTokenなどが必要ありません。これはTrigger ID自体の利用可能期限が3秒と短く、悪用の心配がないためだと思われます。この点は、Trigger IDを取得してからダイアログを開く前に時間のかかる処理などを入れないよう注意する必要があるということも意味します。</p><p><code>/actions/dialogs/open</code>へのリクエストが正常に完了すると、Mattermost上でInteractive Dialogが表示されます。</p><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day16/interactive-dialog.gif alt=video></p><h4 id=interactive-dialog起動時のパラメータ>Interactive Dialog起動時のパラメータ</h4><p>Interactive Dialogを起動する際に送信する<a href=https://github.com/mattermost/mattermost-server/blob/master/model/integration_action.go#L224><code>OpenDialogRequest</code></a>に与えることができるパラメータは下記の通りです。</p><ul><li><code>TriggerId</code>: Slash CommandやInteractive Messageのアクションを実行した時にMattermost内部で生成されるInteractive Dialog起動用のIDを指定します</li><li><code>URL</code>: Interactive Dialogに入力された情報の送信先URLを指定します</li><li><code>Dialog</code>: Interactive Dialog上に表示される要素を指定します<ul><li><code>CallbackId</code>: 統合機能で設定されるIDです。Slash Commandの場合は<code>CommandArgs.RootId</code>、Interactive Messageの場合は<code>PostActionIntegrationRequest.PostId</code>を指定している気がしますが、何に使われているかはいまいちわかりません。</li><li><code>Title</code>: Interactive Dialogのタイトル部分に表示されるテキストを指定します</li><li><code>IntroductionText</code>: <code>Title</code>の下に表示されるダイアログの説明文を指定します</li><li><code>IconURL</code>: ダイアログに表示されるアイコンのURLを指定します</li><li><code>SubmitLabel</code>: ダイアログの決定ボタンのラベルを指定します</li><li><code>NotifyOnCancel</code>: ダイアログのキャンセルボタンが押された時に、サーバーにその旨を通知するかを選択します。<code>true</code>の場合、キャンセル通知がサーバーに送信されます</li><li><code>State</code>: 統語機能によって処理の状態を管理したい場合に設定される任意のフィールドです</li><li><code>Elements</code>: ダイアログ上の入力フィールドを指定します。利用可能な<code>Element</code>については<a href=https://docs.mattermost.com/developer/interactive-dialogs.html#elements>公式ドキュメント</a>を参照してください。</li></ul></li></ul><h3 id=interactive-dialogからのリクエスト受信>Interactive Dialogからのリクエスト受信</h3><p>Interactive Dialogの送信ボタンが押されると、<code>OpenDialogRequest</code>の<code>URL</code>フィールドに指定したURLへリクエストが送信されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>		<span style=color:#75715e>// (2) Interactive Dialogを起動するためのリクエストを構築
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>request</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>OpenDialogRequest</span>{
			<span style=color:#a6e22e>TriggerId</span>: <span style=color:#a6e22e>triggerId</span>,
			<span style=color:#a6e22e>URL</span>:       <span style=color:#e6db74>&#34;http://localhost:8080/actions/dialog&#34;</span>,
			<span style=color:#f92672>...</span>
</code></pre></div><p>送信されるリクエストはMattermostのコードでは<a href=https://github.com/mattermost/mattermost-server/blob/dc1b42390b9bca393d03e2ccdbb16d66cd866431/model/integration_action.go#L230><code>SubmitDialogRequest</code></a>として定義されています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SubmitDialogRequest</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Type</span>       <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;type&#34;`</span>
	<span style=color:#a6e22e>URL</span>        <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;url,omitempty&#34;`</span>
	<span style=color:#a6e22e>CallbackId</span> <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;callback_id&#34;`</span>
	<span style=color:#a6e22e>State</span>      <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;state&#34;`</span>
	<span style=color:#a6e22e>UserId</span>     <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;user_id&#34;`</span>
	<span style=color:#a6e22e>ChannelId</span>  <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;channel_id&#34;`</span>
	<span style=color:#a6e22e>TeamId</span>     <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;team_id&#34;`</span>
	<span style=color:#a6e22e>Submission</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{} <span style=color:#e6db74>`json:&#34;submission&#34;`</span>
	<span style=color:#a6e22e>Cancelled</span>  <span style=color:#66d9ef>bool</span>                   <span style=color:#e6db74>`json:&#34;cancelled&#34;`</span>
}
</code></pre></div><p>ユーザーがInteractive Dialog上で入力したデータは <code>Submission</code> に格納されています。<code>Submission</code>は<code>OpenDialogRequest</code>内の<code>DialogElement</code>の<code>Name</code>をkey、入力データをvalueとしたmap形式のデータです。</p><p>今回のInteractive Dialogでは、<code>title</code>と<code>message</code>という<code>Name</code>を持つ<code>DialogElement</code>を指定しているため、<code>Submission</code>からはこれらの値をキーとするValueが格納されています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#a6e22e>Elements</span>: []<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>DialogElement</span>{{
	<span style=color:#a6e22e>DisplayName</span>: <span style=color:#e6db74>&#34;Title&#34;</span>,
	<span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;title&#34;</span>,
	<span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;text&#34;</span>,
}, {
	<span style=color:#a6e22e>DisplayName</span>: <span style=color:#e6db74>&#34;Message&#34;</span>,
	<span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;message&#34;</span>,
	<span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;textarea&#34;</span>,
}},
<span style=color:#f92672>...</span>
</code></pre></div><p>以上より、Interactive Dialogからのリクエストを受信し、入力内容からMessage Attachmentのメッセージを作るアプリケーションは以下のようになります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/actions/dialog&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()

		<span style=color:#75715e>// (4) リクエストデータの読み出し
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>SubmitDialogRequest</span>
		<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>)

		<span style=color:#a6e22e>title</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Submission</span>[<span style=color:#e6db74>&#34;title&#34;</span>].(<span style=color:#66d9ef>string</span>)
		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
			<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>SubmitDialogResponse</span>{<span style=color:#a6e22e>Error</span>: <span style=color:#e6db74>&#34;failed to get title&#34;</span>}
			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
			<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, string(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>ToJson</span>()))
			<span style=color:#66d9ef>return</span>
		}
		<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Submission</span>[<span style=color:#e6db74>&#34;message&#34;</span>].(<span style=color:#66d9ef>string</span>)
		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
			<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>SubmitDialogResponse</span>{<span style=color:#a6e22e>Error</span>: <span style=color:#e6db74>&#34;failed to get message&#34;</span>}
			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
			<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, string(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>ToJson</span>()))
			<span style=color:#66d9ef>return</span>
		}

		<span style=color:#75715e>// (5) Message Attachmentsインスタンス作成
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>post</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Post</span>{
			<span style=color:#a6e22e>ChannelId</span>: <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>ChannelId</span>,
			<span style=color:#a6e22e>Props</span>: <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>StringInterface</span>{
				<span style=color:#e6db74>&#34;attachments&#34;</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>SlackAttachment</span>{{
					<span style=color:#a6e22e>Title</span>: <span style=color:#a6e22e>title</span>,
					<span style=color:#a6e22e>Text</span>:  <span style=color:#a6e22e>msg</span>,
				}},
			},
		}

		<span style=color:#75715e>// (6) REST APIによるメッセージ投稿
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;http://localhost:8065/api/v4/posts&#34;</span>, <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>post</span>.<span style=color:#a6e22e>ToJson</span>()))
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#e6db74>&#34;Bearer &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>MattermostAccessToken</span>)
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)

		<span style=color:#75715e>// (7) エラー処理
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>dialogResp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>SubmitDialogResponse</span>{}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>Error</span> = <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusCreated</span> {
			<span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>Error</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;failed to request: %s&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Status</span>)
		}
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
		<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, string(<span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>ToJson</span>()))
	})
<span style=color:#f92672>...</span>
</code></pre></div><p>Interactive Dialogからのリクエストを受け取ったら、<code>(4)</code>でリクエストを <a href=https://github.com/mattermost/mattermost-server/blob/dc1b42390b9bca393d03e2ccdbb16d66cd866431/model/integration_action.go#L230><code>SubmitDialogRequest</code></a>形式で読み込みます。そして、<code>SubmitDialogRequest</code>の<code>Submission</code>から<code>title</code>、<code>message</code>をキーに持つ値を取得します。<code>Submission</code>のValueは<code>interface{}</code>型なので、文字列の場合はキャストが必要です。</p><p>データを読み出せたら <code>(5)</code> で、読み出したデータを使ってMessage Attachmentsを含む<code>Post</code>インスタンスを作成し、<code>(6)</code>でREST API経由で投稿を作成しています。REST APIを実行するため、Mattermostのアクセストークン(<code>MattermostAccessToken</code>)を事前に取得しておく必要があります。</p><p>最後に <code>(7)</code> でREST APIの実行結果をチェックし、エラーが発生している場合は<a href=https://github.com/mattermost/mattermost-server/blob/dc1b42390b9bca393d03e2ccdbb16d66cd866431/model/integration_action.go#L242><code>SubmitDialogResponse</code></a>形式のデータを返却します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SubmitDialogResponse</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Error</span>  <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;error,omitempty&#34;`</span>
	<span style=color:#a6e22e>Errors</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;errors,omitempty&#34;`</span>
}
</code></pre></div><p><code>SubmitDialogResponse</code>の<code>Error</code>にはInteractive Dialog全体のエラーとして表示される文字列、<code>Errors</code>には<code>DialogElement</code>の要素ごとのエラーメッセージを指定します。<code>Errors</code>は<code>Submission</code>と同じく<code>DialogElement</code>の<code>Name</code>をkeyとするmap形式でエラーメッセージを指定します。</p><p>試しに、以下のような<code>SubmitDialogResponse</code>を返したときの結果を紹介します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>Errors</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
	<span style=color:#e6db74>&#34;title&#34;</span>:   <span style=color:#e6db74>&#34;title error&#34;</span>,
	<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;message error&#34;</span>,
}
<span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>Error</span> = <span style=color:#e6db74>&#34;error&#34;</span>
<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, string(<span style=color:#a6e22e>dialogResp</span>.<span style=color:#a6e22e>ToJson</span>()))
</code></pre></div><p><img src=https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day16/dialog-error.png alt=error></p><p>以上のようにInteractive Dialogからのリクエストを処理できます。</p><h2 id=さいごに>さいごに</h2><p>本日は、Interactive Dialogの使い方について紹介しました。
明日からは、Mattermostのプラグイン機能について紹介していきます。</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/integration/>integration</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/interactive_dialog/>interactive_dialog</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://github.com/kaakaa name=GitHub><em class="fab fa-github-alt fa-lg"></em></a><a href=https://twitter.com/kaakaa_hoe_prog name=Twitter><em class="fab fa-twitter fa-lg"></em></a><a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita><img src=https://blog.kaakaa.dev/images/qiita.png width=20 height=20 alt=Qiita></a></div><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>