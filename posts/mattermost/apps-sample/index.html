<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>Mattermost Apps Frameworkを触ってみた</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mattermost Apps Frameworkを触ってみた"><meta name=twitter:description content="Mattermost 記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ はじめに Mattermost の新たな統合機能である Apps Framework が Developer Preview になりました。 https://twitter.com/Mattermost/status/1390333864820813831 既存の統合機能やプラグイン機能との違いを確かめるべく、公式開発者向"><meta property="og:title" content="Mattermost Apps Frameworkを触ってみた"><meta property="og:description" content="Mattermost 記事まとめ: https://blog.kaakaa.dev/tags/mattermost/ はじめに Mattermost の新たな統合機能である Apps Framework が Developer Preview になりました。 https://twitter.com/Mattermost/status/1390333864820813831 既存の統合機能やプラグイン機能との違いを確かめるべく、公式開発者向"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaakaa.dev/posts/mattermost/apps-sample/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-08T23:05:21+09:00"><meta property="article:modified_time" content="2021-05-08T23:05:21+09:00"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><a href=https://blog.kaakaa.dev/ class=nav-logo><img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/ id=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Mattermost Apps Frameworkを触ってみた</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>Mattermost 記事まとめ: <a href=https://blog.kaakaa.dev/tags/mattermost/>https://blog.kaakaa.dev/tags/mattermost/</a></p><h1 id=はじめに>はじめに</h1><p>Mattermost の新たな統合機能である Apps Framework が Developer Preview になりました。</p><p><a href=https://twitter.com/Mattermost/status/1390333864820813831>https://twitter.com/Mattermost/status/1390333864820813831</a></p><p>既存の統合機能やプラグイン機能との違いを確かめるべく、公式開発者向けドキュメントにある <a href=https://developers.mattermost.com/integrate/apps/quick-start-go/>Quick start guide (Go)</a> を動かしてみました。</p><p>注: Mattermost Apps Framework は、記事執筆時点では Developer Preview 段階のためプロダクションリリースには含まれていません。Apps Framework を利用するには、Mattermost 開発環境を用意する必要があります。</p><h1 id=mattermost-apps-の開発インストール>Mattermost Apps の開発・インストール</h1><p>Mattermost Apps は、Mattermost インスタンスとは別の Mattermot Apps 用のアプリケーションサーバーとして起動します。</p><p>ここでは、そのアプリケーションサーバーの開発方法と、Mattermost Apps のインストール・利用方法について書いています。以下にある内容は、公式ドキュメントの<a href=https://developers.mattermost.com/integrate/apps/quick-start-go/>Quick start guide (Go)</a>の内容に沿ったものです。</p><nav id=TableOfContents><ul><li><a href=#0-環境設定>0. 環境設定</a></li><li><a href=#1-mattermpst-apps-plugin-のインストール>1. Mattermpst Apps Plugin のインストール</a></li><li><a href=#2-サンプル-mattermost-apps-の作成>2. サンプル Mattermost Apps の作成</a><ul><li><a href=#manifestjson><code>manifest.json</code></a></li><li><a href=#bindingsjson><code>bindings.json</code></a></li><li><a href=#modal-forms>Modal Forms</a></li><li><a href=#アイコンファイル>アイコンファイル</a></li><li><a href=#go-サーバーアプリケーション>Go サーバーアプリケーション</a></li></ul></li><li><a href=#3-サンプル-mattermost-apps-のインストール>3. サンプル Mattermost Apps のインストール</a></li><li><a href=#4-サンプル-mattermost-apps-の実行>4. サンプル Mattermost Apps の実行</a></li></ul></nav><h2 id=0-環境設定>0. 環境設定</h2><p>Mattermost Apps Framework は、まだ Developer Preview 段階ということで、Mattermost のプロダクションリリースには含まれていません。<br>Mattermost Apps Framework を動かすには、<a href=https://developers.mattermost.com/contribute/webapp/developer-setup/>Mattermost 開発環境</a>を構築した上で、以下の環境変数を設定してから Mattermost 開発環境を起動する必要があります。</p><pre><code>$ export MM_FEATUREFLAGS_AppsEnabled=true
</code></pre><p>また、Mattermost Apps Framework は Bot アカウント機能と OAuth 2.0 Service Provider 機能を利用しています。そのため、起動した Mattermost インスタンスの<strong>システムコンソール > 統合機能 > 統合機能管理</strong>から、これらの機能を有効化しておく必要があります。</p><h2 id=1-mattermpst-apps-plugin-のインストール>1. Mattermpst Apps Plugin のインストール</h2><p>Mattermost Apps は <a href=https://github.com/mattermost/mattermost-plugin-apps>mattermost-plugin-apps</a> で管理されるため、まず <a href=https://github.com/mattermost/mattermost-plugin-apps>mattermost-plugin-apps</a> をインストールする必要があります。</p><p>以下のコマンドで <code>mattermost-plugin-apps</code> を Mattermost インスタンスにインストールします。</p><pre><code class=language-bash:install data-lang=bash:install>$ git clone https://github.com/mattermost/mattermost-plugin-apps.git
$ cd mattermost-plugin-apps
$ export MM_SERVICESETTINGS_SITEURL=http://localhost:8065
$ export MM_ADMIN_USERNAME=kaaka
$ export MM_ADMIN_PASSWORD=PASSWORD
$ make deploy
</code></pre><p>環境変数に指定しているのは、Mattermost インスタンス の SiteURL と、管理者権限を持つユーザーのユーザー名/パスワードです。</p><h2 id=2-サンプル-mattermost-apps-の作成>2. サンプル Mattermost Apps の作成</h2><p>ここまでで Mattermost Apps を動作させる準備ができました。ここからは Mattermost Apps 本体を開発していきます。</p><p>Mattermost Apps サーバーと Mattermost インスタンスは、(恐らく)以下のように連携して動作しています。(以下のシーケンス図は、<a href=https://developers.mattermost.com/integrate/apps/lifecycle/>公式ドキュメントの図</a>に少し手を加えたものです)</p><p><img src=https://storage.googleapis.com/zenn-user-upload/e5pgz2kistlm5rwjowf3rodfciv0 alt></p><p>一番右にある <code>Apps Server</code> が、これから開発する Mattermost Apps 本体です。</p><p>シーケンス図の一番下の <code>post bot message</code> の部分に関しては、 Mattermost Apps から Mattermost にメッセージを投稿するロジックを書く必要がありますが、それ以外の部分は Mattermost からのリクエストに対して JSON ファイルを返しているだけです。</p><hr><p>今回は Go 言語で Mattermost Apps を開発するため、<code>go mod init</code> で Go プロジェクトを作成し、<code>github.com/mattermost/mattermost-plugin-apps/apps</code>を依存関係に加えます。（<code>github.com/mattermost/mattermost-plugin-apps/apps</code> には、Mattermost Apps を開発する際に利用可能なユーティリティライブラリが含まれています）
）</p><pre><code>$ go mod init
$ go get github.com/mattermost/mattermost-plugin-apps/apps@master
</code></pre><p>以下のドキュメントにもあるように、<code>github.com/mattermost/mattermost-plugin-apps/apps@master</code>を通じて、Mattermost REST API を実行したり、Apps 用の Key-Value Store を利用できるようになります。</p><p><a href=https://developers.mattermost.com/integrate/apps/using-mattermost-api/>Apps APIs</a></p><h3 id=manifestjson><code>manifest.json</code></h3><p>Go プロジェクトのルートディレクトリに以下の内容で<code>manifest.json</code>というファイルを作成します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;app_id&#34;</span>: <span style=color:#e6db74>&#34;hello-world&#34;</span>,
  <span style=color:#f92672>&#34;display_name&#34;</span>: <span style=color:#e6db74>&#34;Hello, world!&#34;</span>,
  <span style=color:#f92672>&#34;app_type&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
  <span style=color:#f92672>&#34;root_url&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080&#34;</span>,
  <span style=color:#f92672>&#34;requested_permissions&#34;</span>: [<span style=color:#e6db74>&#34;act_as_bot&#34;</span>],
  <span style=color:#f92672>&#34;requested_locations&#34;</span>: [<span style=color:#e6db74>&#34;/channel_header&#34;</span>, <span style=color:#e6db74>&#34;/command&#34;</span>]
}
</code></pre></div><p>この<code>manifest.json</code>は、Mattermost Apps の概要や種別、Apps が要求する Permission、Apps が表示される箇所などを表すファイルです。</p><ul><li><code>app_id</code>、<code>display_name</code>はそれぞれ Apps の ID と表示名を表します。<code>app_id</code>は Apps をインストールする際に使用されます。</li><li><code>app_type</code>は Apps の種別を表します。<code>http</code>、<code>aws_lambda</code>、<code>builtin</code>の中から 1 つを選ぶようですが、<code>http</code>以外を指定した場合の動作についてはまだわかっていません。</li><li><code>app_type</code>に<code>http</code>を指定した場合には、<code>root_url</code>に Apps が起動しているサーバーの URL を記述します。</li><li><code>requested_permissions</code>には、Apps の動作に必要な権限を指定します。 記述できる内容については<a href=https://developers.mattermost.com/integrate/apps/manifest/#permissions>Permissions</a>を参照。</li><li><code>requested_locations</code>には、Apps が干渉する Mattermost UI 上の箇所を指定します。次の<code>bindings.json</code>の記述内容と関連します。 記述できる内容については<a href=https://developers.mattermost.com/integrate/apps/manifest/#locations>Locations</a>を参照。</li></ul><p>Manifest ファイルに記述できる内容については以下の公式ドキュメントで紹介されています。</p><p><a href=https://developers.mattermost.com/integrate/apps/manifest/>Manifest</a></p><h3 id=bindingsjson><code>bindings.json</code></h3><p>次に、Mattermost 上のどこに・どんな機能を配置するかについて記述した<code>bindings.json</code>というファイルを以下の内容で作成します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
  <span style=color:#f92672>&#34;data&#34;</span>: [
    {
      <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;/channel_header&#34;</span>,
      <span style=color:#f92672>&#34;bindings&#34;</span>: [
        {
          <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;send-button&#34;</span>,
          <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080/static/icon.png&#34;</span>,
          <span style=color:#f92672>&#34;label&#34;</span>: <span style=color:#e6db74>&#34;send hello message&#34;</span>,
          <span style=color:#f92672>&#34;call&#34;</span>: {
            <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/send-modal&#34;</span>
          }
        }
      ]
    },
    {
      <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;/command&#34;</span>,
      <span style=color:#f92672>&#34;bindings&#34;</span>: [
        {
          <span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080/static/icon.png&#34;</span>,
          <span style=color:#f92672>&#34;label&#34;</span>: <span style=color:#e6db74>&#34;helloworld&#34;</span>,
          <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Hello World app&#34;</span>,
          <span style=color:#f92672>&#34;hint&#34;</span>: <span style=color:#e6db74>&#34;[send]&#34;</span>,
          <span style=color:#f92672>&#34;bindings&#34;</span>: [
            {
              <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;send&#34;</span>,
              <span style=color:#f92672>&#34;label&#34;</span>: <span style=color:#e6db74>&#34;send&#34;</span>,
              <span style=color:#f92672>&#34;call&#34;</span>: {
                <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/send&#34;</span>
              }
            }
          ]
        }
      ]
    }
  ]
}
</code></pre></div><p><code>bindings.json</code>には、<code>manifest.json</code>の<code>requested_locations</code>に記述した<code>locations</code>に対する詳細な定義を記述していきます。
例えば、<code>"location": "/channel_header"</code>は、Mattermost のチャンネルヘッダー部分に表示されるボタンを表しています。<code>bindings.json</code>には、このチャンネルヘッダーに表示されるボタンの概要(アイコン、ラベル)や、ボタンが押された時の動作を定義します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
		{
			<span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;/channel_header&#34;</span>,
			<span style=color:#f92672>&#34;bindings&#34;</span>: [
				{
					<span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;send-button&#34;</span>,
					<span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080/static/icon.png&#34;</span>,
					<span style=color:#f92672>&#34;label&#34;</span>:<span style=color:#e6db74>&#34;send hello message&#34;</span>,
					<span style=color:#f92672>&#34;call&#34;</span>: {
						<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/send-modal&#34;</span>
					}
				}
			]
		}<span style=color:#960050;background-color:#1e0010>,</span>
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>上記の定義により、<code>http://localhost:8080/static/icon.png</code>をアイコンとし、<code>send hello message</code>をラベルとするボタンがチャンネルヘッダーに表示されます。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/l5i8afh19drgtphwwd7js1qkk9bg alt></p><p>このボタンを押した時の動作は<code>bindings.call</code>に書かれます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#e6db74>&#34;call&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
	<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/send-modal&#34;</span>
}
</code></pre></div><p>この定義により、<code>manifest.json</code>の<code>root_url</code>に書かれた URL をベースとした<code>/send-modal</code>のパス、すなわち<code>http://localhost:8080/send-modal/submit</code>に Mattermost からのリクエストが送信されます。(末尾の<code>/submit</code>が何故つくのか分かっていませんが、サンプルコード上では<code>/submit</code>が末尾に付いた URL へリクエストが送信されているようです)</p><p>この<code>bindings.call</code>には他にも様々なパラメータを指定でき、指定したパラメータの内容によって Mattermost から様々な情報を Apps に対して送信するよう要求できます。</p><p><a href=https://developers.mattermost.com/integrate/apps/call/>Call</a></p><h3 id=modal-forms>Modal Forms</h3><p>前述の <code>http://localhost:8080/send-modal/submit</code> へ送信されたリクエストに対しては、今回のサンプル Apps ではモーダルを表示するための JSON ファイルを返却しています。(この Go プログラムの全容は以降のセクションで紹介しています)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go:main.go data-lang=go:main.go><span style=color:#f92672>...</span>
<span style=color:#75715e>//go:embed send_form.json
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>formData</span> []<span style=color:#66d9ef>byte</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
<span style=color:#f92672>...</span>
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/send-modal/submit&#34;</span>, <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>formData</span>))
<span style=color:#f92672>...</span>
</code></pre></div><p>この時、返却する JSON の内容は下記の通りです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON:send_form.json data-lang=JSON:send_form.json>{
	<span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;form&#34;</span>,
	<span style=color:#f92672>&#34;form&#34;</span>: {
		<span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Hello, world!&#34;</span>,
		<span style=color:#f92672>&#34;icon&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080/static/icon.png&#34;</span>,
		<span style=color:#f92672>&#34;fields&#34;</span>: [
			{
				<span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
				<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;message&#34;</span>,
				<span style=color:#f92672>&#34;label&#34;</span>: <span style=color:#e6db74>&#34;message&#34;</span>
			}
		],
		<span style=color:#f92672>&#34;call&#34;</span>: {
			<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/send&#34;</span>
		}
	}
}
</code></pre></div><p>Mattermost が、上記の JSON を Apps サーバーから受け取ると、以下のようなモーダルウィンドウを表示します。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/jdztut38p9pegb9kwns2cbbo8hqk alt></p><p>返却した JSON の<code>form</code>フィールドの内容が、表示されるモーダルの内容となります。<br>今回は<code>fields</code>配列に<code>"type": "text"</code>のオブジェクト 1 つしかないため、1 つのテキストボックスのみを持つモーダルが表示されました。<code>fields</code>内には他にも<code>text</code>、<code>static_select</code>、<code>dynamic_select</code>、<code>bool</code>、<code>user</code>、<code>channel</code>など、様々なタイプの要素を指定できます。</p><p>詳細については以下のドキュメントに記載があります。</p><p><a href=https://developers.mattermost.com/integrate/apps/interactivity/#modal-forms>Interactivity</a></p><p>モーダルの送信ボタンを押した場合、<code>send_form.json</code>の<code>form.call</code>に書かれたパス (<code>http://localhost:8080/send/submit</code>) へ Mattermost からリクエストが送信されます。（この場合も末尾に<code>/submit</code>が自動で付与されるようです）</p><p>送信されたリクエストは、再び Apps サーバーで扱われます。Apps サーバーの内容は、後述のセクションで紹介します。</p><h3 id=アイコンファイル>アイコンファイル</h3><p>上記で作成してきた JSON ファイル内で参照されているアイコンファイルを取得しておきます。
公式ドキュメントでは、以下のコマンドでダウンロードするよう紹介されていますが、大きすぎるファイルでなければ恐らくどんな画像ファイルでも大丈夫です。</p><pre><code>$ wget https://github.com/mattermost/mattermost-plugin-apps/raw/master/examples/go/helloworld/icon.png
</code></pre><h3 id=go-サーバーアプリケーション>Go サーバーアプリケーション</h3><p>今回開発している Apps サーバーの本体であるサーバーアプリケーションは、下記の Go コードになります。Go 1.16 から導入された<a href=https://golang.org/pkg/embed/>Go embed</a>を使って、今まで作成してきた JSON ファイルを直接読み込んでいます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go:main.go data-lang=go:main.go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;embed&#34;</span>
	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>

	<span style=color:#e6db74>&#34;github.com/mattermost/mattermost-plugin-apps/apps&#34;</span>
	<span style=color:#e6db74>&#34;github.com/mattermost/mattermost-plugin-apps/apps/mmclient&#34;</span>
)

<span style=color:#75715e>//go:embed icon.png
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>iconData</span> []<span style=color:#66d9ef>byte</span>

<span style=color:#75715e>//go:embed manifest.json
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>manifestData</span> []<span style=color:#66d9ef>byte</span>

<span style=color:#75715e>//go:embed bindings.json
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>bindingsData</span> []<span style=color:#66d9ef>byte</span>

<span style=color:#75715e>//go:embed send_form.json
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>formData</span> []<span style=color:#66d9ef>byte</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/manifest.json&#34;</span>, <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>manifestData</span>))
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/bindings&#34;</span>, <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>bindingsData</span>))
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/send/form&#34;</span>, <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>formData</span>))
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/send/submit&#34;</span>, <span style=color:#a6e22e>send</span>)
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/send-modal/submit&#34;</span>, <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>formData</span>))
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/static/icon.png&#34;</span>, <span style=color:#a6e22e>writeData</span>(<span style=color:#e6db74>&#34;image/png&#34;</span>, <span style=color:#a6e22e>iconData</span>))

	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apps</span>.<span style=color:#a6e22e>CallRequest</span>{}
	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>)

	<span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;Hello, world!&#34;</span>
	<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Values</span>[<span style=color:#e6db74>&#34;message&#34;</span>]
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>message</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34; ... and %s!&#34;</span>, <span style=color:#a6e22e>v</span>)
	}
	<span style=color:#a6e22e>mmclient</span>.<span style=color:#a6e22e>AsBot</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>).<span style=color:#a6e22e>DM</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>.<span style=color:#a6e22e>ActingUserID</span>, <span style=color:#a6e22e>message</span>)

	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>apps</span>.<span style=color:#a6e22e>CallResponse</span>{})
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>writeData</span>(<span style=color:#a6e22e>ct</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#a6e22e>ct</span>)
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>data</span>)
	}
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>writeJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>writeData</span>(<span style=color:#e6db74>&#34;application/json&#34;</span>, <span style=color:#a6e22e>data</span>)
}
</code></pre></div><p>前述のモーダルウィンドウの送信ボタンをした際に Mattermost から送信される <code>http://localhost:8080/send/submit</code> へのリクエストは、上記の<code>send</code>関数で処理されます。<code>send</code>関数では、モーダルの入力内容を元にメッセージを作成し、<code>github.com/mattermost/mattermost-plugin-apps/apps/mmclient</code>の関数を使って、Bot として Mattermost にダイレクトメッセージを投稿しています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apps</span>.<span style=color:#a6e22e>CallRequest</span>{}
	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>)

	<span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;Hello, world!&#34;</span>
	<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Values</span>[<span style=color:#e6db74>&#34;message&#34;</span>]
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>message</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34; ... and %s!&#34;</span>, <span style=color:#a6e22e>v</span>)
	}
	<span style=color:#a6e22e>mmclient</span>.<span style=color:#a6e22e>AsBot</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>).<span style=color:#a6e22e>DM</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>.<span style=color:#a6e22e>ActingUserID</span>, <span style=color:#a6e22e>message</span>)

	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>apps</span>.<span style=color:#a6e22e>CallResponse</span>{})
}
<span style=color:#f92672>...</span>
</code></pre></div><p>以上で Mattermost Apps サーバーの開発は完了です。早速 Mattermost Apps をインストールしてみましょう。</p><h2 id=3-サンプル-mattermost-apps-のインストール>3. サンプル Mattermost Apps のインストール</h2><p><code>go run .</code>コマンドで Mattermost Apps サーバーを立ち上げます。</p><p>次に、<code>mattermost-plugin-apps</code>をインストールした Mattermost をブラウザで開き、<code>/apps</code>コマンドを使って Mattermost Apps をインストールします。</p><pre><code>/apps debug-add-manifest --url http://localhost:8080/manifest.json
/apps install hello-world
</code></pre><p><code>/apps debug-add-manifest</code>で、Mattermost Apps サーバーから<code>manifest.json</code>を取得し、その内容を検証します。問題がなければ<code>/apps install</code>コマンドで Apps ID を指定してインストールを実行します。</p><p>インストール実行時に、インストールしようとしている Apps が要求する Permission と Locations が表示され、App Secret の入力を促されます。App Secret の内容はなんでも良いらしいです。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/bwq66dapqo4tffu2m40jvdv3pltj alt></p><p>App Secret を入力して、<code>Approve and Install</code>ボタンをクリックすると、Apps のインストールが完了します。Apps をインストールした後、ページをリロードすると、チャンネルヘッダー部分にボタンが表示されているはずです。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/l5i8afh19drgtphwwd7js1qkk9bg alt></p><p>また、Apps インストール後に<code>/apps list</code>コマンドを実行すると、インストールされている Mattermost Apps の一覧を確認できます。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/wgrkbyx67xra1t5jlj565rzsjzyt alt></p><h2 id=4-サンプル-mattermost-apps-の実行>4. サンプル Mattermost Apps の実行</h2><p>チャンネルヘッダー部分のボタンをクリックすると、モーダルウィンドウが開きます。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/jdztut38p9pegb9kwns2cbbo8hqk alt></p><p>メッセージを入力し、送信ボタンを押すと、Bot からダイレクトメッセージが届きます。</p><p><img src=https://storage.googleapis.com/zenn-user-upload/uqxdln0cf4rhuo42w8zy5lxlu3pj alt></p><h1 id=さいごに>さいごに</h1><p>Developer Preview 版として公開された Mattermost Apps Framework を動かしてみました。</p><p>Mattermost Apps Framework は、既存の統合機能(WebHook、Slash Command)とプラグインの中間のような位置付けのものという印象を受けましたが、使用できるパラメータの数も多く、どのような場面で使うべきかはもう少し触ってみないとなんとも言えません。
ただ、AWS Lambda と連携するタイプの Apps が現段階で利用できることから、FaaS 基盤と連携可能という点がポイントになるような気がしています。実際、Apps のインストールや Mattermost UI に関わる部分は Apps サーバーから JSON を返すだけで実現できるため、フルスタックなサーバーアプリケーションを立てておくことなく、必要な部分の処理だけをコードとして書けば良いという形式になっています。この点より、プラグインより軽量であり、かつプラグインのように Mattermost と密接に連携した機能を開発できる基盤なのかなという印象があります。また、FaaS 的な基盤として<a href=https://n8n.io/>n8n</a>なんかと上手く連携する方法が見つかルト、いろいろ幅が広がりそうです。</p><p>以下は妄想です。</p><p>今回実装したようなサンプル Apps ぐらいなら、<a href=https://developers.mattermost.com/extend/plugins/>プラグイン</a>として実装できますが、プラグインは Mattermost インスタンスと密接に連携して動作するため、Mattermost インスタンスの動作に意図しない影響を与えてしまう可能性もあります。また、マルチクラスタ構成を組んでいる場合、プラグインによる機能追加を全てのインスタンスで同一の状態に揃えることが難しいということも、背景としてあったのでは無いかと考えられます（妄想ですが）。Mattermost プラグイン自体は Mattermost を自組織向けにカスタマイズするための強力な仕組みですが、やはり統合機能は別のサーバーで管理した方が利用しやすいという考えもあったのではないかと思われます。ただ、既存の統合機能では HTTP リクエストのやり取りぐらいしかできないため、もう少し踏み込んだ統合機能の実装として Mattermost Apps Framework が生まれたのではないかと想像しています。</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/mattermost/>mattermost</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/integrations/>integrations</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://github.com/kaakaa name=GitHub><em class="fab fa-github-alt fa-lg"></em></a><a href=https://twitter.com/kaakaa_hoe_prog name=Twitter><em class="fab fa-twitter fa-lg"></em></a><a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita><img src=https://blog.kaakaa.dev/images/qiita.png width=20 height=20 alt=Qiita></a></div><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>