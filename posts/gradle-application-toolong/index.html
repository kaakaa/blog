<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>Gradle Application プラグインで生成したスクリプトが実行できないことがある</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gradle Application プラグインで生成したスクリプトが実行できないことがある"><meta name=twitter:description content="要約 Windowsのcmd.exeの制約により、GradleのApplicationプラグインで生成したBatファイルが実行不可能になること"><meta property="og:title" content="Gradle Application プラグインで生成したスクリプトが実行できないことがある"><meta property="og:description" content="要約 Windowsのcmd.exeの制約により、GradleのApplicationプラグインで生成したBatファイルが実行不可能になること"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaakaa.dev/posts/gradle-application-toolong/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-06T18:05:18+09:00"><meta property="article:modified_time" content="2020-01-06T18:05:18+09:00"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><a href=https://blog.kaakaa.dev/ class=nav-logo><img src=https://blog.kaakaa.dev/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/ id=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search/ id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/index.xml id=Subscribe><em class="fas fa-rss fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Gradle Application プラグインで生成したスクリプトが実行できないことがある</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><h1 id=要約>要約</h1><ul><li>Windowsのcmd.exeの制約により、GradleのApplicationプラグインで生成したBatファイルが実行不可能になることがあった</li><li>Applicationプラグインが出力するBatファイル内でのクラスパスの指定を、<strong>jarファイル指定でなくディレクトリ指定となるよう</strong>設定を追加することにより回避可能となった</li><li>検証用プロジェクト: <a href=https://github.com/kaakaa/gradle-application-too-long-input-line>https://github.com/kaakaa/gradle-application-too-long-input-line</a></li></ul><h1 id=背景>背景</h1><p><a href=https://docs.gradle.org/current/userguide/application_plugin.html>GradleのApplicationプラグイン</a>を利用すると、CLIツールとして作成したJavaアプリを実行するためのスクリプトを生成することができる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-build.gradle data-lang=build.gradle>plugins <span style=color:#f92672>{</span>
    id <span style=color:#e6db74>&#39;application&#39;</span>
<span style=color:#f92672>}</span>

application<span style=color:#f92672>.</span><span style=color:#a6e22e>mainClassName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;sample.Main&#39;</span>
</code></pre></div><p><code>main</code> メソッドを持つクラスを <code>application.mainClassName</code> として指定し、<a href=https://docs.gradle.org/current/userguide/application_plugin.html>Gradle Applicationプラグイン</a>の <code>installDist</code> タスクを実行することで、<code>$buildDir/install/${APPLICATION_NAME}</code> 配下に実行可能な形式のアプリケーションが出力される。</p><pre><code>$ ./gradlew installDist
$ tree build/install/
build/install/
└── app
    ├── bin
    │   ├── app
    │   └── app.bat
    └── lib
        ├── deps.jar
        ...
</code></pre><p><code>bin</code> ディレクトリ配下にはUnix実行用のスクリプトファイルとWindows実行用のBATファイルが出力される。アプリケーションが依存するライブラリは <code>lib</code> 配下にまとめられ、実行用スクリプトファイルから <code>lib</code> 配下の依存ライブラリが参照されるようになっている。</p><h1 id=問題>問題</h1><p>Windows環境において、Applicationプラグインから出力されたBATファイルを実行すると、エラーとなることがあった。</p><pre><code>&gt; build/install/gradle-application-too-long-input-line/bin/gradle-application-too-long-input-line.bat
The input line is too long.
The syntax of the command is incorrect.
</code></pre><p><a href="https://github.com/kaakaa/gradle-application-too-long-input-line/commit/db4f53c31faabe65d4682ef091002abf82c8e754/checks?check_suite_id=385831791#step:5:7">GitHub Actionsでの実行結果</a></p><h1 id=原因>原因</h1><p>Windowsのcmd.exeでは１行が<strong>8191文字</strong>を超えるようなコマンドは実行できない。</p><p><a href=https://support.microsoft.com/ja-jp/help/830473/command-prompt-cmd-exe-command-line-string-limitation>コマンド プロンプト (cmd.exe) のコマンドライン文字列の制限</a></p><blockquote><p>Microsoft Windows XP 以降の Windows を実行しているコンピューターでは、コマンド プロンプトで使用できる文字列の最大長は 8191 文字です。</p></blockquote><p>GradleのApplicationプラグインは、実行スクリプトファイル内で依存ライブラリを <code>set CLASSPATH=%APP_HOME%\lib\deps1.jar;%APP_HOME%\lib\deps2.jar;...</code> のようにjarファイル単位でクラスパス文字列に結合しているため、依存ライブラリが多すぎると <strong>8191文字制約</strong> に引っかかることがある。</p><p><a href=https://github.com/kaakaa/gradle-application-too-long-input-line/blob/9aa12fa00228b8240679b32a5f80e3514a1f2b9d/build/install/gradle-application-too-long-input-line/bin/gradle-application-too-long-input-line.bat#L82>サンプルBATファイル</a></p><h1 id=解決方法>解決方法</h1><p>実行用スクリプトファイルを生成した後、クラスパス指定に関する行をディレクトリ参照1つで済むように文字列置換することでこのエラーは回避可能。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-build.gradle data-lang=build.gradle><span style=color:#f92672>...</span>
tasks<span style=color:#f92672>.</span><span style=color:#a6e22e>withType</span><span style=color:#f92672>(</span>CreateStartScripts<span style=color:#f92672>).</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> task <span style=color:#f92672>-&gt;</span>
    task<span style=color:#f92672>.</span><span style=color:#a6e22e>doLast</span> <span style=color:#f92672>{</span>
        String text <span style=color:#f92672>=</span> task<span style=color:#f92672>.</span><span style=color:#a6e22e>windowsScript</span><span style=color:#f92672>.</span><span style=color:#a6e22e>text</span>
        text <span style=color:#f92672>=</span> text<span style=color:#f92672>.</span><span style=color:#a6e22e>replaceFirst</span><span style=color:#f92672>(</span><span style=color:#e6db74>/(set CLASSPATH=%APP_HOME%\\lib\\).*/</span><span style=color:#f92672>,</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;${it[1]}*&#34;</span> <span style=color:#f92672>})</span>
        task<span style=color:#f92672>.</span><span style=color:#a6e22e>windowsScript</span><span style=color:#f92672>.</span><span style=color:#a6e22e>write</span> text
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>...</span>
</code></pre></div><p>参考: <a href=https://gist.github.com/jlmelville/2bfe9277e9e2c0ff79b6>Workaround for gradle application plugin &lsquo;the input line is too long&rsquo; error on Windows</a></p><p>上記の設定を <code>build.gradle</code> に追加し、再度BATファイルを生成するとエラーとなっていた行は下記のように置換されるため、文字数制限に抵触しなくなる。</p><pre><code>...
set CLASSPATH=%APP_HOME%\lib\*
...
</code></pre><p><a href=https://github.com/kaakaa/gradle-application-too-long-input-line/blob/master/build/install/gradle-application-too-long-input-line/bin/gradle-application-too-long-input-line.bat#L82>サンプルBATファイル</a></p><p>この設定を加えることで、エラーが解消できた。</p><p><a href="https://github.com/kaakaa/gradle-application-too-long-input-line/commit/0eb5385d110c4e56ff7a288ac8fba120c73d2b1a/checks?check_suite_id=385886281#step:5:7">GitHub Actionsでの実行結果</a></p><hr><p>(別の解決方法として、fatjarを作成してそのfatjarのみをクラスパスで参照するよう書き換えれば良いかとも思いましたが、<code>lib</code>ディレクトリ内のその他の依存関係を排除する方法が分からなかったので、そちらの方法は断念しました)</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/gradle/>Gradle</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/application-plugin/>Application plugin</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://github.com/kaakaa name=GitHub><em class="fab fa-github-alt fa-lg"></em></a><a href=https://twitter.com/kaakaa_hoe_prog name=Twitter><em class="fab fa-twitter fa-lg"></em></a><a class=social-icon href=https://twitter.com/kaakaa_hoe_prog name=Qiita><img src=https://blog.kaakaa.dev/images/qiita.png width=20 height=20 alt=Qiita></a></div><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>