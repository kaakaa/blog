<!doctype html><html lang=ja-jp><head><meta charset=utf-8><title>LINE BOTで何やって良いか分からないのでとりあえずiftttに飛ばしてみる</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57299975-4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-57299975-4')</script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.kaakaa.dev/index.xml title="kaakaa blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.kaakaa.dev/images/icon.png"><meta name=twitter:title content="LINE BOTで何やって良いか分からないのでとりあえずiftttに飛ばしてみる"><meta name=twitter:description content="LINE BOTを始めBot界隈が盛り上がってきてますが、BotKit公開されても何すれば良いか分からない人間なので、とりあえずiftttへのパス作"><meta property="og:title" content="LINE BOTで何やって良いか分からないのでとりあえずiftttに飛ばしてみる"><meta property="og:description" content="LINE BOTを始めBot界隈が盛り上がってきてますが、BotKit公開されても何すれば良いか分からない人間なので、とりあえずiftttへのパス作"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaakaa.dev/posts/line-bot%E3%81%A7%E4%BD%95%E3%82%84%E3%81%A3%E3%81%A6%E8%89%AF%E3%81%84%E3%81%8B%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84%E3%81%AE%E3%81%A7%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9Aifttt%E3%81%AB%E9%A3%9B%E3%81%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B/"><meta property="og:image" content="https://blog.kaakaa.dev/images/icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-04-13T22:23:13+09:00"><meta property="article:modified_time" content="2016-04-13T22:23:13+09:00"><link rel=stylesheet href=https://blog.kaakaa.dev/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://blog.kaakaa.dev/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.kaakaa.dev/js/bundle.js></script><script src=https://blog.kaakaa.dev/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.82.0"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>LINE BOTで何やって良いか分からないのでとりあえずiftttに飛ばしてみる</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>LINE BOTを始めBot界隈が盛り上がってきてますが、BotKit公開されても何すれば良いか分からない人間なので、とりあえずiftttへのパス作っとけば夢は広がるだろうというアレです。</p><p>下記の情報の組み合わせでできました。</p><p><a href=http://qiita.com/yuya_takeyama/items/0660a59d13e2cd0b2516>LINE BOT をとりあえずタダで Heroku で動かす - Qiita</a>
<a href=http://qiita.com/kawahiro311/items/41dca04fe899d4d142d9>AWS LambdaとIFTTTでお手軽にpush通知を実現する - Qiita</a></p><p><a href="https://dashboard.heroku.com/new?button-url=https%3A%2F%2Fgithub.com%2Fkaakaa%2Fline-ifttt&template=https%3A%2F%2Fgithub.com%2Fkaakaa%2Fline-ifttt"><img src=https://www.herokucdn.com/deploy/button.svg alt=Deploy></a></p><p>動かすには下記が必要</p><ul><li><a href=https://business.line.me/services/products/4/introduction>LINE BOT API のトライアルアカウン</a></li><li><a href=https://ifttt.com/maker>iftttのMakerチャンネルのSecretKey</a></li></ul><hr><p>流れとしてはLINE BOTからHerokuへCallbackし、HerokuからiftttのMakerチャンネルへリクエストを飛ばしてます。
<a href=https://ifttt.com/maker>Connect Maker to hundreds of apps - IFTTT</a></p><p>Makerチャンネルへリクエストを飛ばすと<code>Congratulations! You've ～</code> という定型文が返されるので、それをまたLINEへつぶやくようにしています。
（リクエストがiftttへ届いたことを表しているだけで、レシピがエラーとなったかどうかは判別できなそうです）</p><p>Makerチャンネルはiftttのレシピ毎に<code>EventName</code>を指定できるため、LINEでのメッセージの先頭でその<code>EventName</code>を指定できるようにしており、Herokuにアプリ一つ立てておくだけで、iftttの複数のレシピに対応できるはずです。</p><p><img src=https://qiita-image-store.s3.amazonaws.com/0/9891/20b58a7c-f787-9d79-6a0c-c3d07da018b5.png alt=line-ifttt-7.png></p><p>LINE上で<code>ifttt-test hogehoge</code>とつぶやけば、<code>EventName</code>が<code>ifttt-test</code>のレシピが実行されるはずです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rb:app.rb data-lang=rb:app.rb><span style=color:#75715e># Mostly taken from http://qiita.com/masuidrive/items/1042d93740a7a72242a3</span>
<span style=color:#75715e># And https://github.com/yuya-takeyama/line-echo</span>

require <span style=color:#e6db74>&#39;sinatra/base&#39;</span>
require <span style=color:#e6db74>&#39;json&#39;</span>
require <span style=color:#e6db74>&#39;rest-client&#39;</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Sinatra</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  <span style=color:#66d9ef>SECRET_KEY</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;MAKER_SECRET_KEY&#39;</span><span style=color:#f92672>]</span> <span style=color:#75715e># Maker channel&#39;s secret key</span>
  <span style=color:#66d9ef>EVENT_NAME_DEFAULT</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;MAKER_EVENT_NAME_DEFAULT&#39;</span><span style=color:#f92672>]</span> <span style=color:#75715e># Maker channel&#39;s default event name</span>
  
  post <span style=color:#e6db74>&#39;/linebot/callback&#39;</span> <span style=color:#66d9ef>do</span>
    params <span style=color:#f92672>=</span> <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>parse(request<span style=color:#f92672>.</span>body<span style=color:#f92672>.</span>read)
    
    <span style=color:#66d9ef>RestClient</span><span style=color:#f92672>.</span>proxy <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;FIXIE_URL&#39;</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;FIXIE_URL&#39;</span><span style=color:#f92672>]</span>
    params<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;result&#39;</span><span style=color:#f92672>].</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>msg<span style=color:#f92672>|</span>
      event, message <span style=color:#f92672>=</span> msg<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;content&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;text&#39;</span><span style=color:#f92672>].</span>split(<span style=color:#e6db74>&#39; &#39;</span>, <span style=color:#ae81ff>2</span>)
      response <span style=color:#f92672>=</span> request_to_ifttt(event, message)
      
      request_to_line(<span style=color:#f92672>[</span>msg<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;content&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;from&#39;</span><span style=color:#f92672>]]</span>, response)
    <span style=color:#66d9ef>end</span>

    <span style=color:#e6db74>&#34;OK&#34;</span>
  <span style=color:#66d9ef>end</span>

  helpers <span style=color:#66d9ef>do</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>request_to_ifttt</span>(event <span style=color:#f92672>=</span> <span style=color:#66d9ef>EVENT_NAME</span>, message)
      <span style=color:#75715e># Maker channel&#39;s extra data</span>
      request_content <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>value1</span>: message,
        <span style=color:#e6db74>value2</span>: <span style=color:#e6db74>&#39;from&#39;</span>,
        <span style=color:#e6db74>value3</span>: <span style=color:#e6db74>&#39;Line Bot&#39;</span>
      }

      endpoint_uri <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://maker.ifttt.com/trigger/</span><span style=color:#e6db74>#{</span>event<span style=color:#e6db74>}</span><span style=color:#e6db74>/with/key/</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>SECRET_KEY</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
      content_json <span style=color:#f92672>=</span> request_content<span style=color:#f92672>.</span>to_json
      
      response <span style=color:#f92672>=</span> <span style=color:#66d9ef>RestClient</span><span style=color:#f92672>.</span>post(endpoint_uri, content_json, {
        <span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;application/json; charset=UTF-8&#39;</span>,
        <span style=color:#e6db74>&#39;Content-Length&#39;</span> <span style=color:#f92672>=&gt;</span> content_json<span style=color:#f92672>.</span>length
      })
    <span style=color:#66d9ef>end</span>

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>request_to_line</span>(send_to, message)
      request_content <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>to</span>: send_to,
        <span style=color:#e6db74>toChannel</span>: <span style=color:#ae81ff>1383378250</span>, <span style=color:#75715e># Fixed  value</span>
        <span style=color:#e6db74>eventType</span>: <span style=color:#e6db74>&#34;138311608800106203&#34;</span>, <span style=color:#75715e># Fixed value</span>
        <span style=color:#e6db74>content</span>: { 
            <span style=color:#e6db74>&#34;contentType&#34;</span>: <span style=color:#ae81ff>1</span>,  <span style=color:#75715e># Text type message</span>
            <span style=color:#e6db74>&#34;toType&#34;</span>: <span style=color:#ae81ff>1</span>,
            <span style=color:#e6db74>&#34;text&#34;</span>: message
        }
      }

      endpoint_uri <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://trialbot-api.line.me/v1/events&#39;</span>
      content_json <span style=color:#f92672>=</span> request_content<span style=color:#f92672>.</span>to_json

      <span style=color:#66d9ef>RestClient</span><span style=color:#f92672>.</span>post(endpoint_uri, content_json, {
        <span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;application/json; charset=UTF-8&#39;</span>,
        <span style=color:#e6db74>&#39;X-Line-ChannelID&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LINE_CHANNEL_ID&#34;</span><span style=color:#f92672>]</span>,
        <span style=color:#e6db74>&#39;X-Line-ChannelSecret&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LINE_CHANNEL_SECRET&#34;</span><span style=color:#f92672>]</span>,
        <span style=color:#e6db74>&#39;X-Line-Trusted-User-With-ACL&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LINE_CHANNEL_MID&#34;</span><span style=color:#f92672>]</span>,
      })
    <span style=color:#66d9ef>end</span>  
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><hr><p>Makerチャンネルのリクエストにはパラメータを３つ（<code>Value1</code>, <code>Value2</code>, <code>Value3</code>）まで指定できます。
<img src=https://qiita-image-store.s3.amazonaws.com/0/9891/a3e22ceb-38d6-506b-f897-0ed1c6de704e.png alt=line-ifttt-8.png>
<code>EventName</code>はそのままの意味、<code>OccurredAt</code>はリクエストを受け付けた日時になります。</p><p>ifttt上で指定する場合は<code>Value1</code>のように先頭を大文字の<code>V</code>にしないとエラーになりますが、リクエストパラメータでは先頭小文字の<code>value1</code>でないとダメみたいです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rb data-lang=rb>      <span style=color:#75715e># Maker channel&#39;s extra data</span>
      request_content <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>value1</span>: message,
        <span style=color:#e6db74>value2</span>: <span style=color:#e6db74>&#39;from&#39;</span>,
        <span style=color:#e6db74>value3</span>: <span style=color:#e6db74>&#39;Line Bot&#39;</span>
      }
</code></pre></div><hr><p>ソースは下記に置いてます。 (masuidrive さんに怒られたら消す)
<a href=https://github.com/kaakaa/line-ifttt>kaakaa/line-ifttt</a></p><p>とりあえず作ったもののやりたいことがない。</p><div class=blog-tags><a href=https://blog.kaakaa.dev/tags/heroku/>Heroku</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/ifttt/>ifttt</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/line/>Line</a>&nbsp;
<a href=https://blog.kaakaa.dev/tags/linebot/>linebot</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='kaakaa-blog',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div class=container><p class="credits copyright"><a href=https://blog.kaakaa.dev/about>Yusuke Nemoto</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.kaakaa.dev/>kaakaa blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>